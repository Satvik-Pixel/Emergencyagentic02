<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Summary ‚Äî EmergencyAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --red:        #ff2d3b;
            --red-glow:   rgba(255,45,59,0.25);
            --red-dim:    rgba(255,45,59,0.08);
            --bg:         #0a0b0d;
            --surface:    #111318;
            --surface-2:  #181c24;
            --border:     rgba(255,255,255,0.07);
            --border-hi:  rgba(255,255,255,0.14);
            --text:       #f0f2f5;
            --muted:      #6b7280;
            --muted-2:    #4b5563;
            --green:      #00e676;
            --green-dim:  rgba(0,230,118,0.08);
            --blue:       #3b82f6;
            --blue-dim:   rgba(59,130,246,0.08);
            --amber:      #f59e0b;
            --amber-dim:  rgba(245,158,11,0.08);
            --purple:     #a78bfa;
            --purple-dim: rgba(167,139,250,0.08);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 32px 16px 100px;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ Background atmosphere ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed; inset: 0;
            background:
                radial-gradient(ellipse 50% 40% at 10% -5%, rgba(255,45,59,0.10) 0%, transparent 55%),
                radial-gradient(ellipse 40% 35% at 90% 105%, rgba(59,130,246,0.07) 0%, transparent 55%),
                radial-gradient(ellipse 30% 30% at 50% 50%, rgba(167,139,250,0.03) 0%, transparent 70%);
            pointer-events: none; z-index: 0;
        }
        body::after {
            content: '';
            position: fixed; inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.012) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.012) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none; z-index: 0;
        }

        /* ‚îÄ‚îÄ Keyframes ‚îÄ‚îÄ */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(22px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.25; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--red-glow); }
            50%       { box-shadow: 0 0 40px rgba(255,45,59,0.4), 0 0 80px rgba(255,45,59,0.12); }
        }
        @keyframes pulseRing {
            0%   { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(2.2); opacity: 0; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes shimmer {
            0%   { background-position: -200% center; }
            100% { background-position:  200% center; }
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes barFill {
            from { width: 0; }
        }
        @keyframes ambBounce {
            0%, 100% { transform: translateX(0); }
            25%       { transform: translateX(4px); }
            75%       { transform: translateX(-2px); }
        }
        @keyframes scanLine {
            0%   { transform: translateY(-100%); opacity: 0.6; }
            100% { transform: translateY(100%);  opacity: 0; }
        }
        @keyframes heartbeat {
            0%   { transform: scale(1); }
            15%  { transform: scale(1.2); }
            30%  { transform: scale(1); }
            45%  { transform: scale(1.1); }
            60%  { transform: scale(1); }
            100% { transform: scale(1); }
        }

        .animate-up {
            opacity: 0;
            animation: fadeUp 0.55s ease forwards;
        }

        /* ‚îÄ‚îÄ Page Header ‚îÄ‚îÄ */
        .page-header {
            max-width: 640px;
            margin: 0 auto 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative; z-index: 1;
            opacity: 0;
            animation: fadeUp 0.5s ease 0.05s forwards;
        }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .logo-mark {
            position: relative;
            width: 46px; height: 46px;
            border-radius: 13px;
            background: var(--red);
            display: flex; align-items: center; justify-content: center;
            font-size: 21px;
            flex-shrink: 0;
            animation: glow 2.5s ease-in-out infinite;
        }
        .logo-mark::before {
            content: '';
            position: absolute; inset: -4px;
            border-radius: 17px;
            border: 1.5px solid rgba(255,45,59,0.3);
            animation: pulseRing 2s ease-out infinite;
        }
        .header-branding { display: flex; flex-direction: column; gap: 2px; }
        .page-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            letter-spacing: 0.08em;
            line-height: 1;
        }
        .page-title span { color: var(--red); }
        .page-subtitle {
            font-size: 10px;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 500;
        }
        .back-btn {
            font-size: 12px;
            font-weight: 700;
            color: var(--muted);
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.25s ease;
            background: var(--surface);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .back-btn:hover { border-color: rgba(255,45,59,0.4); color: var(--red); background: var(--red-dim); }

        /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
        .container { max-width: 640px; margin: 0 auto; position: relative; z-index: 1; }

        /* ‚îÄ‚îÄ Hero Banner ‚îÄ‚îÄ */
        .summary-hero {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }
        .summary-hero:hover {
            border-color: rgba(245,158,11,0.4);
            box-shadow: 0 0 32px rgba(245,158,11,0.12);
            transform: translateY(-1px);
        }
        .summary-hero:active { transform: scale(0.995); }
        .hero-click-hint {
            display: flex; align-items: center; gap: 6px;
            margin-top: 14px;
            padding: 8px 12px;
            background: rgba(245,158,11,0.06);
            border: 1px dashed rgba(245,158,11,0.25);
            border-radius: 10px;
            font-size: 11px; color: rgba(245,158,11,0.8);
            letter-spacing: 0.05em;
            animation: hintPulse 2.5s ease-in-out infinite;
        }
        @keyframes hintPulse {
            0%, 100% { opacity: 0.7; }
            50%       { opacity: 1; }
        }
        .hero-click-hint.hidden { display: none; }
        .summary-hero::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,45,59,0.5), transparent);
        }
        .summary-hero::after {
            content: '';
            position: absolute; top: 0; right: -60px;
            width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(255,45,59,0.08) 0%, transparent 70%);
            pointer-events: none;
        }
        .hero-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
        }
        .hero-icon {
            font-size: 52px;
            line-height: 1;
            animation: heartbeat 2.4s ease infinite;
            flex-shrink: 0;
        }
        .hero-text { flex: 1; }
        .hero-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 30px;
            letter-spacing: 0.08em;
            color: var(--text);
            line-height: 1;
            margin-bottom: 6px;
        }
        .hero-sub {
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 500;
        }
        .hero-timestamp {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--muted-2);
            background: var(--surface-2);
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            white-space: nowrap;
        }

        /* Reference number strip */
        .ref-strip {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--surface-2);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .ref-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            flex-shrink: 0;
        }
        .ref-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 0.08em;
            flex: 1;
        }
        .ref-badge {
            display: flex; align-items: center; gap: 5px;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: rgba(0,230,118,0.1);
            color: var(--green);
            border: 1px solid rgba(0,230,118,0.25);
        }
        .ref-badge-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            background: var(--green);
            animation: blink 1.4s ease-in-out infinite;
        }

        /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 40px rgba(0,0,0,0.35);
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
        }
        .card:hover { box-shadow: 0 12px 50px rgba(0,0,0,0.45); border-color: var(--border-hi); }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border);
        }
        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 16px;
            letter-spacing: 0.1em;
            color: var(--text);
            display: flex; align-items: center; gap: 8px;
        }
        .card-title-icon {
            width: 30px; height: 30px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
        }
        .icon-red    { background: var(--red-dim);    border: 1px solid rgba(255,45,59,0.2); }
        .icon-blue   { background: var(--blue-dim);   border: 1px solid rgba(59,130,246,0.2); }
        .icon-green  { background: var(--green-dim);  border: 1px solid rgba(0,230,118,0.2); }
        .icon-amber  { background: var(--amber-dim);  border: 1px solid rgba(245,158,11,0.2); }
        .icon-purple { background: var(--purple-dim); border: 1px solid rgba(167,139,250,0.2); }

        /* ‚îÄ‚îÄ Section tags ‚îÄ‚îÄ */
        .section-tag {
            font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em;
            padding: 3px 8px;
            border-radius: 6px;
        }
        .tag-red    { background: var(--red-dim);    color: var(--red);    border: 1px solid rgba(255,45,59,0.2); }
        .tag-blue   { background: var(--blue-dim);   color: var(--blue);   border: 1px solid rgba(59,130,246,0.2); }
        .tag-green  { background: var(--green-dim);  color: var(--green);  border: 1px solid rgba(0,230,118,0.2); }
        .tag-amber  { background: var(--amber-dim);  color: var(--amber);  border: 1px solid rgba(245,158,11,0.2); }
        .tag-purple { background: var(--purple-dim); color: var(--purple); border: 1px solid rgba(167,139,250,0.2); }

        /* ‚îÄ‚îÄ Triage Grid ‚îÄ‚îÄ */
        .triage-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .triage-item {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            transition: border-color 0.2s;
        }
        .triage-item:hover { border-color: var(--border-hi); }
        .triage-item.full  { grid-column: 1 / -1; }
        .triage-label {
            font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--muted); margin-bottom: 6px;
            display: block;
        }
        .triage-value {
            font-size: 14px; font-weight: 500; color: var(--text);
        }

        /* Severity display */
        .severity-display {
            display: flex; align-items: center; gap: 10px;
        }
        .severity-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px; letter-spacing: 0.05em;
        }
        .severity-bar-wrap {
            flex: 1; height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: 2px; overflow: hidden;
        }
        .severity-bar {
            height: 100%; border-radius: 2px;
            background: linear-gradient(90deg, var(--green), var(--amber), var(--red));
            animation: barFill 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Badges */
        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 3px 10px; border-radius: 999px;
            font-size: 10px; font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: 0.08em; text-transform: uppercase;
        }
        .badge-critical { background: rgba(255,45,59,0.15);  color: var(--red);    border: 1px solid rgba(255,45,59,0.3); }
        .badge-moderate { background: rgba(245,158,11,0.15); color: var(--amber);  border: 1px solid rgba(245,158,11,0.3); }
        .badge-low      { background: rgba(0,230,118,0.12);  color: var(--green);  border: 1px solid rgba(0,230,118,0.25); }

        /* Notes block */
        .notes-block {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-left: 3px solid var(--amber);
            font-size: 13px;
            color: var(--muted);
            line-height: 1.75;
        }

        /* ‚îÄ‚îÄ Location ‚îÄ‚îÄ */
        .location-display {
            display: flex; align-items: flex-start; gap: 14px;
            padding: 16px;
            background: var(--surface-2);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .location-pin {
            width: 36px; height: 36px;
            background: var(--red-dim);
            border: 1px solid rgba(255,45,59,0.25);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px;
            flex-shrink: 0;
        }
        .location-text { flex: 1; min-width: 0; }
        .location-name {
            font-size: 14px; font-weight: 600; color: var(--text);
            margin-bottom: 4px;
        }
        .location-coords {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--muted);
        }

        /* ‚îÄ‚îÄ Ambulance Status ‚Äî BIG FEATURE ‚îÄ‚îÄ */
        .ambulance-hero {
            background: linear-gradient(135deg, rgba(245,158,11,0.06), rgba(255,45,59,0.04));
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }
        .ambulance-hero::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(245,158,11,0.4), transparent);
        }
        .amb-top {
            display: flex; align-items: center; gap: 14px;
            margin-bottom: 16px;
        }
        .amb-icon-wrap {
            position: relative;
            width: 56px; height: 56px;
            border-radius: 16px;
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.25);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }
        .amb-icon-wrap.dispatched { animation: ambBounce 1.2s ease infinite; }
        .amb-siren {
            position: absolute; top: -3px; right: -3px;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--red);
            box-shadow: 0 0 8px var(--red-glow);
            animation: blink 0.8s ease-in-out infinite;
        }
        .amb-info { flex: 1; }
        .amb-status-label {
            font-size: 10px; font-weight: 700;
            color: var(--muted); letter-spacing: 0.1em;
            text-transform: uppercase; margin-bottom: 4px;
        }
        .amb-status-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px; letter-spacing: 0.06em;
            color: var(--amber);
            line-height: 1;
        }
        .amb-status-sub {
            font-size: 12px; color: var(--muted); margin-top: 3px;
        }
        .amb-eta-pill {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.25);
            border-radius: 12px;
            padding: 10px 16px;
            flex-shrink: 0;
        }
        .amb-eta-label {
            font-size: 9px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--muted); margin-bottom: 2px;
        }
        .amb-eta-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px; letter-spacing: 0.05em;
            color: var(--amber);
            line-height: 1;
        }
        .amb-eta-unit {
            font-size: 9px; font-weight: 600;
            text-transform: uppercase; color: var(--muted-2);
            letter-spacing: 0.06em;
        }

        /* Progress track */
        .amb-track {
            display: flex; align-items: center; gap: 0;
        }
        .amb-step {
            display: flex; flex-direction: column; align-items: center;
            flex: 1;
        }
        .amb-step-dot {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--surface-2);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            margin-bottom: 6px;
            transition: all 0.4s ease;
            position: relative;
        }
        .amb-step-dot.active {
            border-color: var(--amber);
            background: rgba(245,158,11,0.12);
            box-shadow: 0 0 12px rgba(245,158,11,0.3);
        }
        .amb-step-dot.done {
            border-color: var(--green);
            background: rgba(0,230,118,0.1);
        }
        .amb-step-dot.active::after {
            content: '';
            position: absolute; inset: -5px;
            border-radius: 50%;
            border: 1px solid rgba(245,158,11,0.3);
            animation: pulseRing 1.5s ease-out infinite;
        }
        .amb-step-label {
            font-size: 9px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.07em;
            color: var(--muted); text-align: center;
        }
        .amb-step-label.active { color: var(--amber); }
        .amb-step-label.done   { color: var(--green); }
        .amb-connector {
            flex: 1; height: 2px;
            background: var(--border);
            margin-bottom: 22px;
            position: relative;
            overflow: hidden;
        }
        .amb-connector::after {
            content: '';
            position: absolute; inset: 0;
            background: var(--green);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.8s ease;
        }
        .amb-connector.done::after { transform: scaleX(1); }

        /* ‚îÄ‚îÄ Doctor Card ‚îÄ‚îÄ */
        .doctor-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            background: var(--surface-2);
            border-radius: 14px;
            border: 1px solid var(--border);
            margin-bottom: 12px;
            transition: border-color 0.25s, box-shadow 0.25s;
            position: relative;
            overflow: hidden;
        }
        .doctor-card:hover {
            border-color: var(--border-hi);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .doctor-card::before {
            content: '';
            position: absolute; left: 0; top: 0; bottom: 0;
            width: 3px;
            background: var(--blue);
        }
        .doctor-avatar {
            width: 50px; height: 50px;
            border-radius: 14px;
            background: var(--blue-dim);
            border: 1px solid rgba(59,130,246,0.25);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            position: relative;
        }
        .doctor-online {
            position: absolute; bottom: -2px; right: -2px;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--green);
            border: 2px solid var(--surface-2);
            animation: blink 2s ease-in-out infinite;
        }
        .doctor-info { flex: 1; min-width: 0; }
        .doctor-name {
            font-size: 15px; font-weight: 700; color: var(--text);
            margin-bottom: 2px;
        }
        .doctor-specialty {
            font-size: 12px; color: var(--blue);
            font-weight: 500; margin-bottom: 3px;
        }
        .doctor-meta {
            font-size: 11px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .doctor-status {
            display: flex; flex-direction: column; align-items: flex-end; gap: 5px;
            flex-shrink: 0;
        }
        .doctor-status-badge {
            font-size: 10px; font-weight: 700;
            padding: 3px 9px; border-radius: 999px;
            text-transform: uppercase; letter-spacing: 0.07em;
        }
        .status-preparing {
            background: rgba(245,158,11,0.12);
            color: var(--amber);
            border: 1px solid rgba(245,158,11,0.25);
        }
        .status-available {
            background: rgba(0,230,118,0.1);
            color: var(--green);
            border: 1px solid rgba(0,230,118,0.2);
        }
        .status-en-route {
            background: rgba(59,130,246,0.1);
            color: var(--blue);
            border: 1px solid rgba(59,130,246,0.2);
        }
        .doctor-exp {
            font-size: 11px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Scan line effect on doctor card */
        .doctor-card-scan {
            position: absolute;
            inset: 0; pointer-events: none; overflow: hidden;
        }
        .doctor-card-scan::after {
            content: '';
            position: absolute; left: 0; right: 0;
            height: 40%;
            background: linear-gradient(180deg, transparent, rgba(59,130,246,0.03), transparent);
            animation: scanLine 3s ease-in-out infinite;
        }

        /* ‚îÄ‚îÄ Hospital List ‚îÄ‚îÄ */
        .hospital-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface-2);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
            transition: all 0.2s ease;
            animation: fadeUp 0.4s ease forwards;
            opacity: 0;
        }
        .hospital-row:hover {
            border-color: var(--border-hi);
            transform: translateX(2px);
        }
        .hospital-row.chosen {
            border-color: rgba(59,130,246,0.4);
            background: var(--blue-dim);
        }
        .hosp-left { display: flex; align-items: center; gap: 12px; }
        .hosp-rank {
            width: 26px; height: 26px;
            border-radius: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700;
            color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
        }
        .hospital-row.chosen .hosp-rank {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }
        .hosp-info { display: flex; flex-direction: column; gap: 2px; }
        .hosp-name { font-size: 13px; font-weight: 600; color: var(--text); }
        .hosp-detail {
            font-size: 11px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .hosp-right { display: flex; align-items: center; gap: 8px; }
        .hosp-dist {
            font-size: 12px; font-weight: 600;
            color: var(--muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .hosp-beds {
            font-size: 10px; font-weight: 700;
            padding: 2px 8px; border-radius: 999px;
            text-transform: uppercase; letter-spacing: 0.06em;
        }
        .beds-ok  { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,230,118,0.2); }
        .beds-low { background: var(--amber-dim); color: var(--amber); border: 1px solid rgba(245,158,11,0.2); }

        /* ‚îÄ‚îÄ Bill Card ‚îÄ‚îÄ */
        .bill-display {
            display: flex; align-items: center; gap: 16px;
            padding: 18px 20px;
            background: var(--surface-2);
            border-radius: 14px;
            border: 1px solid rgba(167,139,250,0.2);
            background: rgba(167,139,250,0.04);
        }
        .bill-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            background: var(--purple-dim);
            border: 1px solid rgba(167,139,250,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 21px;
            flex-shrink: 0;
        }
        .bill-label {
            font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--muted); margin-bottom: 4px;
        }
        .bill-amount {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px; letter-spacing: 0.05em;
            color: var(--purple);
        }
        .bill-note {
            font-size: 11px; color: var(--muted-2); margin-top: 2px;
        }

        /* ‚îÄ‚îÄ No data ‚îÄ‚îÄ */
        .no-data {
            text-align: center; color: var(--muted);
            font-size: 13px; padding: 24px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
        .actions {
            display: flex; flex-direction: column; gap: 10px;
        }
        .actions a {
            display: block; text-align: center;
            padding: 14px;
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px; font-weight: 700;
            text-decoration: none;
            transition: all 0.25s ease;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            position: relative; overflow: hidden;
        }
        .link-primary {
            background: var(--red);
            color: white;
            border: 1px solid var(--red);
            box-shadow: 0 4px 20px rgba(255,45,59,0.25);
        }
        .link-primary::before {
            content: '';
            position: absolute; top: 0; left: -100%; right: -100%; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2.5s linear infinite;
            background-size: 200% auto;
        }
        .link-primary:hover { background: #e8001a; box-shadow: 0 6px 28px rgba(255,45,59,0.4); transform: translateY(-1px); }
        .link-secondary {
            background: var(--surface-2);
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .link-secondary:hover { border-color: var(--border-hi); color: var(--text); }

        /* ‚îÄ‚îÄ Divider ‚îÄ‚îÄ */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 18px 0;
        }

        .hidden { display: none !important; }

        @media (max-width: 520px) {
            .triage-grid, .logistics-grid { grid-template-columns: 1fr; }
            .amb-top { flex-wrap: wrap; }
            .hero-top { flex-direction: column; }
            .hero-timestamp { align-self: flex-start; }
            .page-header { gap: 10px; }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           AI EMERGENCY CALL OVERLAY
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #callOverlay {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(135deg, #020b1a 0%, #041228 40%, #071e3d 100%);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(12px);
        }
        #callOverlay.active { opacity: 1; pointer-events: all; }
        #callOverlay::before {
            content: '';
            position: absolute; inset: 0;
            background:
                radial-gradient(ellipse 60% 50% at 50% 0%, rgba(59,130,246,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 40% 40% at 80% 100%, rgba(0,230,118,0.06) 0%, transparent 50%);
            pointer-events: none;
        }
        .call-card {
            position: relative;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 28px;
            padding: 36px 32px 28px;
            width: 90%; max-width: 420px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(59,130,246,0.1);
            backdrop-filter: blur(20px);
            transform: scale(0.85);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
        }
        #callOverlay.active .call-card { transform: scale(1); }

        /* Phone ring pulse */
        .phone-ring-wrap {
            position: relative;
            width: 96px; height: 96px;
            margin: 0 auto 20px;
        }
        .ring-pulse {
            position: absolute; inset: 0;
            border-radius: 50%;
            border: 2px solid rgba(59,130,246,0.5);
            animation: ringExpand 1.8s ease-out infinite;
        }
        .ring-pulse:nth-child(2) { animation-delay: 0.6s; }
        .ring-pulse:nth-child(3) { animation-delay: 1.2s; }
        @keyframes ringExpand {
            0%   { transform: scale(0.9); opacity: 0.8; }
            100% { transform: scale(2.0); opacity: 0; }
        }
        .phone-icon-circle {
            position: absolute; inset: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 32px rgba(37,99,235,0.5);
            animation: phonePulse 1.2s ease-in-out infinite;
        }
        @keyframes phonePulse {
            0%, 100% { box-shadow: 0 8px 32px rgba(37,99,235,0.5); }
            50%       { box-shadow: 0 8px 48px rgba(37,99,235,0.8), 0 0 0 8px rgba(37,99,235,0.1); }
        }

        .call-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px; letter-spacing: 0.1em;
            color: #fff; margin-bottom: 4px;
        }
        .call-subtitle { font-size: 12px; color: rgba(255,255,255,0.45); margin-bottom: 16px; letter-spacing: 0.06em; text-transform: uppercase; }

        /* State badge */
        .call-state-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 14px; border-radius: 999px;
            font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
            margin-bottom: 18px;
            transition: all 0.4s ease;
        }
        .call-state-badge.dialing   { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
        .call-state-badge.ringing   { background: rgba(59,130,246,0.15); color: #3b82f6; border: 1px solid rgba(59,130,246,0.3); }
        .call-state-badge.connected { background: rgba(0,230,118,0.12);  color: #00e676; border: 1px solid rgba(0,230,118,0.25); }
        .call-state-badge.speaking  { background: rgba(167,139,250,0.15); color: #a78bfa; border: 1px solid rgba(167,139,250,0.3); }
        .call-state-badge.confirmed { background: rgba(0,230,118,0.15);  color: #00e676; border: 1px solid rgba(0,230,118,0.3); }
        .call-state-badge.completed { background: rgba(0,230,118,0.15);  color: #00e676; border: 1px solid rgba(0,230,118,0.3); }
        .state-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: currentColor;
            animation: blink 1s ease-in-out infinite;
        }

        /* Transcript panel */
        .transcript-panel {
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 16px;
            padding: 14px;
            max-height: 180px;
            overflow-y: auto;
            text-align: left;
            margin-bottom: 18px;
            scroll-behavior: smooth;
        }
        .transcript-panel::-webkit-scrollbar { width: 3px; }
        .transcript-panel::-webkit-scrollbar-track { background: transparent; }
        .transcript-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 2px; }

        .tx-line {
            display: flex; gap: 8px; margin-bottom: 10px;
            animation: fadeUp 0.3s ease forwards;
            opacity: 0;
        }
        .tx-line:last-child { margin-bottom: 0; }
        .tx-who {
            font-size: 9px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.1em; padding: 2px 6px; border-radius: 4px;
            flex-shrink: 0; margin-top: 2px; height: fit-content;
        }
        .tx-ai   { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .tx-user { background: rgba(0,230,118,0.15); color: #00e676; }
        .tx-text { font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.5; }

        /* End call button */
        #endCallBtn {
            width: 100%; padding: 13px;
            border-radius: 14px;
            background: rgba(255,45,59,0.15);
            border: 1px solid rgba(255,45,59,0.3);
            color: #ff2d3b;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px; font-weight: 700;
            letter-spacing: 0.06em; text-transform: uppercase;
            cursor: not-allowed; opacity: 0.4;
            transition: all 0.3s ease;
        }
        #endCallBtn.ready {
            opacity: 1; cursor: pointer;
            animation: glow 2s ease-in-out infinite;
        }
        #endCallBtn.ready:hover {
            background: rgba(255,45,59,0.25);
            box-shadow: 0 4px 20px rgba(255,45,59,0.3);
        }

        /* Wave speaking animation */
        .speaking-wave {
            display: none; align-items: center; justify-content: center; gap: 4px;
            height: 20px; margin-bottom: 8px;
        }
        .speaking-wave.active { display: flex; }
        .wave-bar {
            width: 3px; border-radius: 2px;
            background: #a78bfa;
            animation: waveAnim 0.8s ease-in-out infinite;
        }
        .wave-bar:nth-child(1) { animation-delay: 0s;    height: 8px; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s;  height: 16px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s;  height: 20px; }
        .wave-bar:nth-child(4) { animation-delay: 0.1s;  height: 16px; }
        .wave-bar:nth-child(5) { animation-delay: 0s;    height: 8px; }
        @keyframes waveAnim {
            0%, 100% { transform: scaleY(0.5); }
            50%       { transform: scaleY(1); }
        }

        /* Incident log */
        .incident-log {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-left: 3px solid var(--green);
            margin-top: 10px;
        }
        .incident-log-title {
            font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--muted); margin-bottom: 8px;
        }
        .inc-entry {
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; color: var(--muted);
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
            animation: fadeUp 0.3s ease forwards; opacity: 0;
        }
        .inc-entry:last-child { border-bottom: none; }
        .inc-check { color: var(--green); font-size: 13px; flex-shrink: 0; }
        .inc-entry.pending .inc-check { color: var(--muted-2); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           AMBULANCE TRACKING MAP
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .map-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0;
            margin-bottom: 14px;
            overflow: hidden;
            position: relative;
        }
        .map-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 18px 24px 14px;
            border-bottom: 1px solid var(--border);
        }
        .map-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px; letter-spacing: 0.1em;
            display: flex; align-items: center; gap: 8px;
        }
        .map-title-icon {
            width: 30px; height: 30px; border-radius: 8px;
            background: var(--amber-dim); border: 1px solid rgba(245,158,11,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
        }
        .map-controls { display: flex; gap: 8px; }
        .map-btn {
            padding: 6px 14px;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px; font-weight: 700;
            letter-spacing: 0.06em; text-transform: uppercase;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .map-btn:hover { border-color: var(--border-hi); color: var(--text); }
        .map-btn.primary { background: rgba(245,158,11,0.15); color: var(--amber); border-color: rgba(245,158,11,0.3); }
        .map-btn.primary:hover { background: rgba(245,158,11,0.25); }

        .map-body { display: flex; flex-direction: column; }
        @media (min-width: 600px) { .map-body { flex-direction: row; } }

        .map-canvas-wrap {
            flex: 1; min-height: 300px;
            position: relative; overflow: hidden;
            background: #0d1117;
        }
        #ambCanvas { width: 100%; height: 100%; display: block; }

        .map-info-panel {
            width: 100%; padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex; flex-direction: row; gap: 0;
        }
        @media (min-width: 600px) {
            .map-info-panel {
                width: 160px; flex-direction: column;
                border-top: none; border-left: 1px solid var(--border);
                padding: 20px 16px;
            }
        }
        .map-stat {
            flex: 1; text-align: center;
            padding: 8px 4px;
            border-right: 1px solid var(--border);
        }
        .map-stat:last-child { border-right: none; }
        @media (min-width: 600px) {
            .map-stat { border-right: none; border-bottom: 1px solid var(--border); text-align: left; padding: 12px 0; }
            .map-stat:last-child { border-bottom: none; }
        }
        .map-stat-label {
            font-size: 9px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--muted); margin-bottom: 4px;
        }
        .map-stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px; letter-spacing: 0.05em;
            color: var(--amber); line-height: 1;
        }
        .map-stat-unit { font-size: 10px; color: var(--muted-2); margin-top: 1px; }
        .map-status-badge {
            margin-top: 12px; padding: 6px 10px;
            border-radius: 8px; text-align: center;
            font-size: 10px; font-weight: 700; letter-spacing: 0.07em; text-transform: uppercase;
        }
        .map-status-badge.en-route { background: rgba(245,158,11,0.12); color: var(--amber); border: 1px solid rgba(245,158,11,0.25); }
        .map-status-badge.arrived  { background: rgba(0,230,118,0.12);  color: var(--green); border: 1px solid rgba(0,230,118,0.25); }
    </style>
</head>
<body>

<header class="page-header">
    <div class="header-left">
        <div class="logo-mark">üö®</div>
        <div class="header-branding">
            <div class="page-title"><span>Emergency</span>AI</div>
            <div class="page-subtitle">Rapid Response System</div>
        </div>
    </div>
    <a href="/" class="back-btn">‚Üê New Alert</a>
</header>

<div class="container">

    <!-- ‚îÄ‚îÄ Hero ‚îÄ‚îÄ -->
    <div class="summary-hero animate-up" style="animation-delay:0.1s" id="summaryHero" onclick="onSummaryClick()">
        <div class="hero-top">
            <div class="hero-icon">üìã</div>
            <div class="hero-text">
                <div class="hero-title">Emergency Summary</div>
                <div class="hero-sub">Full incident report &amp; response log</div>
            </div>
            <div class="hero-timestamp" id="heroTimestamp">‚Äî</div>
        </div>
        <div class="ref-strip">
            <span class="ref-label">Ref #</span>
            <span class="ref-value" id="refNumber">‚Äî</span>
            <div class="ref-badge"><span class="ref-badge-dot"></span> Submitted</div>
        </div>
        <div class="hero-click-hint" id="heroClickHint">
            üìû Tap this card to trigger AI confirmation call &amp; ambulance tracking ‚Üí
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Triage Assessment ‚îÄ‚îÄ -->
    <div class="card animate-up" style="animation-delay:0.18s">
        <div class="card-header">
            <div class="card-title">
                <div class="card-title-icon icon-red">ü©∫</div>
                Triage Assessment
            </div>
            <span class="section-tag tag-red" id="severityTagHeader">‚Äî</span>
        </div>

        <div class="triage-grid">
            <div class="triage-item">
                <span class="triage-label">Emergency Type</span>
                <div class="triage-value" id="emergencyType">‚Äî</div>
            </div>
            <div class="triage-item">
                <span class="triage-label">Department</span>
                <div class="triage-value" id="department">‚Äî</div>
            </div>
            <div class="triage-item">
                <span class="triage-label">Required Specialist</span>
                <div class="triage-value" id="specialist">‚Äî</div>
            </div>
            <div class="triage-item">
                <span class="triage-label">Priority</span>
                <div class="triage-value" id="priority">‚Äî</div>
            </div>
            <div class="triage-item full">
                <span class="triage-label">Severity Score</span>
                <div class="severity-display">
                    <span class="severity-num" id="severityScore">‚Äî</span>
                    <div class="severity-bar-wrap">
                        <div class="severity-bar" id="severityBar" style="width:0%"></div>
                    </div>
                    <span id="severityBadge"></span>
                </div>
            </div>
        </div>

        <div class="notes-block hidden" id="triageNotes"></div>
    </div>

    <!-- ‚îÄ‚îÄ Location ‚îÄ‚îÄ -->
    <div class="card animate-up" style="animation-delay:0.24s">
        <div class="card-header">
            <div class="card-title">
                <div class="card-title-icon icon-red">üìç</div>
                Incident Location
            </div>
        </div>
        <div class="location-display">
            <div class="location-pin">üìç</div>
            <div class="location-text">
                <div class="location-name" id="locationName">‚Äî</div>
                <div class="location-coords" id="locationCoords">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Ambulance Status ‚îÄ‚îÄ -->
    <div class="card animate-up" style="animation-delay:0.3s">
        <div class="card-header">
            <div class="card-title">
                <div class="card-title-icon icon-amber">üöë</div>
                Ambulance Dispatch
            </div>
            <span class="section-tag tag-amber" id="ambStatusTag">‚Äî</span>
        </div>

        <div class="ambulance-hero">
            <div class="amb-top">
                <div class="amb-icon-wrap" id="ambIconWrap">
                    üöë
                    <div class="amb-siren" id="ambSiren"></div>
                </div>
                <div class="amb-info">
                    <div class="amb-status-label">Current Status</div>
                    <div class="amb-status-value" id="ambStatusValue">‚Äî</div>
                    <div class="amb-status-sub" id="ambStatusSub">Awaiting dispatch data‚Ä¶</div>
                </div>
                <div class="amb-eta-pill">
                    <div class="amb-eta-label">ETA</div>
                    <div class="amb-eta-value" id="ambEta">‚Äî</div>
                    <div class="amb-eta-unit">Minutes</div>
                </div>
            </div>

            <!-- Dispatch progress track -->
            <div class="amb-track">
                <div class="amb-step">
                    <div class="amb-step-dot done" id="step-received">‚úì</div>
                    <div class="amb-step-label done">Received</div>
                </div>
                <div class="amb-connector done" id="conn-1"></div>
                <div class="amb-step">
                    <div class="amb-step-dot" id="step-dispatched">üöë</div>
                    <div class="amb-step-label" id="lbl-dispatched">Dispatched</div>
                </div>
                <div class="amb-connector" id="conn-2"></div>
                <div class="amb-step">
                    <div class="amb-step-dot" id="step-enroute">üó∫Ô∏è</div>
                    <div class="amb-step-label" id="lbl-enroute">En Route</div>
                </div>
                <div class="amb-connector" id="conn-3"></div>
                <div class="amb-step">
                    <div class="amb-step-dot" id="step-arrived">üè•</div>
                    <div class="amb-step-label" id="lbl-arrived">Arrived</div>
                </div>
            </div>
        </div>

        <!-- Bill inside ambulance card -->
        <div class="bill-display">
            <div class="bill-icon">üí∞</div>
            <div>
                <div class="bill-label">Estimated Bill</div>
                <div class="bill-amount" id="expectedBill">‚Äî</div>
                <div class="bill-note">Estimate only ¬∑ Final billing at discharge</div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Assigned Doctor ‚îÄ‚îÄ -->
    <div class="card animate-up" style="animation-delay:0.36s">
        <div class="card-header">
            <div class="card-title">
                <div class="card-title-icon icon-blue">üë®‚Äç‚öïÔ∏è</div>
                Assigned Medical Team
            </div>
            <span class="section-tag tag-blue">On Duty</span>
        </div>

        <div id="doctorList">
            <!-- filled by JS -->
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Nearby Hospitals ‚îÄ‚îÄ -->
    <div class="card animate-up" style="animation-delay:0.42s">
        <div class="card-header">
            <div class="card-title">
                <div class="card-title-icon icon-green">üè•</div>
                Nearby Hospitals
            </div>
            <span class="section-tag tag-green" id="hospCount">‚Äî</span>
        </div>
        <div id="hospitalList">
            <div class="no-data">No hospital data available</div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Ambulance Live Tracking Map ‚îÄ‚îÄ -->
    <div class="map-section animate-up" style="animation-delay:0.45s">
        <div class="map-header">
            <div class="map-title">
                <div class="map-title-icon">üó∫Ô∏è</div>
                Live Ambulance Tracking
            </div>
            <div class="map-controls">
                <span class="section-tag tag-amber" id="mapLiveTag">‚óè Waiting</span>
            </div>
        </div>
        <div class="map-body">
            <div class="map-canvas-wrap">
                <canvas id="ambCanvas"></canvas>
            </div>
            <div class="map-info-panel">
                <div class="map-stat">
                    <div class="map-stat-label">Speed</div>
                    <div class="map-stat-value" id="mapSpeed">‚Äî</div>
                    <div class="map-stat-unit">km/h</div>
                </div>
                <div class="map-stat">
                    <div class="map-stat-label">Distance</div>
                    <div class="map-stat-value" id="mapDist">‚Äî</div>
                    <div class="map-stat-unit">km left</div>
                </div>
                <div class="map-stat">
                    <div class="map-stat-label">ETA</div>
                    <div class="map-stat-value" id="mapEta">‚Äî</div>
                    <div class="map-stat-unit">min:sec</div>
                </div>
                <div class="map-status-badge en-route" id="mapStatusBadge">En Route</div>
            </div>
        </div>
        <!-- Incident Log -->
        <div style="padding:0 20px 16px">
            <div class="incident-log">
                <div class="incident-log-title">üìã Incident Log</div>
                <div id="incidentLog">
                    <div class="inc-entry pending">
                        <span class="inc-check">‚óã</span>
                        <span>AI Confirmation Call Initiated</span>
                    </div>
                    <div class="inc-entry pending">
                        <span class="inc-check">‚óã</span>
                        <span>Patient Status Confirmed</span>
                    </div>
                    <div class="inc-entry pending">
                        <span class="inc-check">‚óã</span>
                        <span>Call Completed Successfully</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Actions ‚îÄ‚îÄ -->
    <div class="card animate-up" style="animation-delay:0.54s">
        <div class="actions">
            <a href="/emergency-form" class="link-secondary">üö® Submit New Emergency ‚Üí</a>
            <a href="/doctor-dashboard" class="link-secondary">View Doctor Dashboard</a>
        </div>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AI EMERGENCY CALL OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="callOverlay">
    <div class="call-card">
        <!-- Phone ring -->
        <div class="phone-ring-wrap">
            <div class="ring-pulse"></div>
            <div class="ring-pulse"></div>
            <div class="ring-pulse"></div>
            <div class="phone-icon-circle">üìû</div>
        </div>

        <div class="call-title">QwikAid AI Calling‚Ä¶</div>
        <div class="call-subtitle">Emergency Confirmation System</div>

        <!-- State badge -->
        <div class="call-state-badge dialing" id="callStateBadge">
            <span class="state-dot"></span>
            <span id="callStateText">Dialing</span>
        </div>

        <!-- Speaking wave -->
        <div class="speaking-wave" id="speakingWave">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>

        <!-- Transcript -->
        <div class="transcript-panel" id="callTranscript">
            <!-- Lines added by JS -->
        </div>

        <!-- End call -->
        <button id="endCallBtn" onclick="endCall()" disabled>End Call</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    /* ‚îÄ‚îÄ Timestamp ‚îÄ‚îÄ */
    const ts = new Date();
    document.getElementById('heroTimestamp').textContent =
        ts.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) + ' ¬∑ ' +
        ts.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DATA LOADING ‚Äî 2 live sources in priority order:
       1. sessionStorage 'emergencyResult'  (set by index.html after /select-hospital)
       2. Server session  GET /session-state (survives hard refresh)
       Demo fallback only fills fields that are completely missing.
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    let d = null;
    let chosenHospitalName = null;

    // 1. sessionStorage ‚Äî freshest, set immediately after /select-hospital
    try {
        const stored = sessionStorage.getItem("emergencyResult");
        if (stored) {
            d = JSON.parse(stored);
            chosenHospitalName = d.chosen_hospital || null;
        }
    } catch (e) {}

    // 2. Server session ‚Äî survives hard refresh
    if (!d || !d.triage) {
        try {
            const resp = await fetch('/session-state');
            if (resp.ok) {
                const srv = await resp.json();
                if (srv.emergency && srv.emergency.triage) {
                    const em = srv.emergency;
                    const bk = srv.booking  || {};
                    chosenHospitalName = bk.hospital_name || chosenHospitalName;
                    d = {
                        reference_number: bk.case_id ? `EMG-${bk.case_id}` : '‚Äî',
                        triage:           em.triage,
                        location:         em.location,
                        ambulance_status: em.ambulance_status,
                        doctor_status:    em.doctor_status,
                        expected_bill:    em.expected_bill,
                        hospitals:        em.hospitals || [],
                        chosen_hospital:  bk.hospital_name || null,
                    };
                }
            }
        } catch (_) {}
    }

    // Fallback skeleton ‚Äî only used when there is truly no session data
    const NO_DATA = !d || !d.triage;
    if (NO_DATA) {
        d = d || {};
        d.reference_number  = d.reference_number  || '‚Äî';
        d.ambulance_status  = d.ambulance_status  || 'Received';
        d.expected_bill     = d.expected_bill     || '‚Äî';
        d.hospitals         = d.hospitals         || [];
        d.triage = d.triage || {
            emergency_type:'‚Äî', required_specialist:'‚Äî',
            recommended_department:'‚Äî', priority:'‚Äî',
            severity_score: 0, severity_level:'Unknown',
            estimated_arrival:'‚Äî',
        };
    }

    const t = d.triage;

    /* ‚îÄ‚îÄ Expose session data for AI call + map ‚îÄ‚îÄ */
    chosenHospitalName = chosenHospitalName || d.chosen_hospital || (d.hospitals && d.hospitals.find(h=>h.chosen)?.name) || 'Assigned Hospital';
    window._sessionHospital = chosenHospitalName;
    window._sessionLocation = (typeof d.location === 'string' ? d.location : (d.location?.address || '')) || 'your location';
    window._sessionEta      = t.estimated_arrival ? t.estimated_arrival + ' minutes' : 'shortly';
    window._mapStartLabel   = chosenHospitalName;
    window._mapEndLabel     = window._sessionLocation.split(',')[0] || 'Patient Location';

    /* ‚îÄ‚îÄ Reference ‚îÄ‚îÄ */
    document.getElementById('refNumber').textContent = d.reference_number || '‚Äî';

    /* ‚îÄ‚îÄ Triage fields ‚îÄ‚îÄ */
    document.getElementById('emergencyType').textContent = t.emergency_type              || t.condition         || '‚Äî';
    document.getElementById('specialist').textContent    = t.required_specialist         || '‚Äî';
    document.getElementById('department').textContent    = t.recommended_department      || '‚Äî';
    document.getElementById('priority').textContent      = t.priority                    || '‚Äî';

    const score = parseFloat(t.severity_score) || 0;
    const level = (t.severity_level || 'unknown').toLowerCase();
    const badgeClass = level.includes('critical') ? 'badge-critical'
                     : level.includes('moderate') ? 'badge-moderate'
                     : score > 0 ? 'badge-low' : '';
    const tagClass   = level.includes('critical') ? 'tag-red'
                     : level.includes('moderate') ? 'tag-amber'
                     : score > 0 ? 'tag-green' : 'tag-amber';

    document.getElementById('severityScore').textContent = score > 0 ? `${score}/10` : '‚Äî';
    document.getElementById('severityScore').style.color =
        level.includes('critical') ? 'var(--red)' :
        level.includes('moderate') ? 'var(--amber)' : 'var(--green)';
    document.getElementById('severityBadge').innerHTML = t.severity_level
        ? `<span class="badge ${badgeClass}">${t.severity_level}</span>` : '';
    document.getElementById('severityTagHeader').textContent = t.severity_level || '‚Äî';
    document.getElementById('severityTagHeader').className   = `section-tag ${tagClass}`;

    requestAnimationFrame(() => setTimeout(() => {
        document.getElementById('severityBar').style.width = `${(score / 10) * 100}%`;
    }, 350));

    if (t.notes) {
        const nb = document.getElementById('triageNotes');
        nb.textContent = t.notes;
        nb.classList.remove('hidden');
    }

    /* ‚îÄ‚îÄ Location ‚îÄ‚îÄ */
    const locStr = typeof d.location === 'string' ? d.location : (d.location?.address || '‚Äî');
    document.getElementById('locationName').textContent   = locStr;
    document.getElementById('locationCoords').textContent = d.location_coords || '';

    /* ‚îÄ‚îÄ Ambulance Dispatch ‚îÄ‚îÄ */
    const ambStatusRaw = d.ambulance_status || 'Received';
    const ambStepMap   = { 'received': 1, 'dispatched': 2, 'en route': 3, 'enroute': 3, 'arrived': 4 };
    const ambStep      = d.ambulance_step || ambStepMap[ambStatusRaw.toLowerCase()] || 1;

    document.getElementById('ambStatusValue').textContent = ambStatusRaw;
    document.getElementById('ambStatusTag').textContent   = ambStatusRaw;
    document.getElementById('ambEta').textContent = t.estimated_arrival || '‚Äî';

    const subMessages = {
        1: 'Alert received ‚Äî locating nearest ambulance',
        2: 'Ambulance dispatched ‚Äî en route to your location',
        3: 'Ambulance is on its way ‚Äî standby',
        4: 'Ambulance has arrived ‚Äî medical team boarding'
    };
    document.getElementById('ambStatusSub').textContent = subMessages[ambStep] || subMessages[1];

    ['received','dispatched','enroute','arrived'].forEach((s, i) => {
        const dot  = document.getElementById(`step-${s}`);
        const lbl  = document.getElementById(`lbl-${s}`);
        const conn = document.getElementById(`conn-${i + 1}`);
        if (!dot) return;
        if (i + 1 < ambStep) {
            dot.className   = 'amb-step-dot done';
            dot.textContent = '‚úì';
            if (lbl) lbl.className = 'amb-step-label done';
            if (conn) conn.classList.add('done');
        } else if (i + 1 === ambStep) {
            dot.className = 'amb-step-dot active';
            if (lbl) lbl.className = 'amb-step-label active';
            if (ambStep > 1) {
                const prev = document.getElementById(`conn-${i}`);
                if (prev) prev.classList.add('done');
            }
        }
    });
    if (ambStep >= 2) document.getElementById('ambIconWrap').classList.add('dispatched');

    /* ‚îÄ‚îÄ Bill ‚îÄ‚îÄ */
    document.getElementById('expectedBill').textContent = d.expected_bill || '‚Äî';

    /* ‚îÄ‚îÄ Doctors ‚îÄ‚îÄ */
    const docList = document.getElementById('doctorList');
    const doctors = d.doctors && d.doctors.length ? d.doctors : [];

    if (!doctors.length && d.doctor_status) {
        // app.py returns doctor_status as a plain string ‚Äî show it clearly
        docList.innerHTML = `
        <div class="doctor-card">
            <div class="doctor-avatar">üë®‚Äç‚öïÔ∏è<div class="doctor-online"></div></div>
            <div class="doctor-info">
                <div class="doctor-name">Assigned Physician</div>
                <div class="doctor-specialty" style="color:var(--blue)">${d.doctor_status}</div>
                <div class="doctor-meta">Notified and preparing for arrival</div>
            </div>
            <div class="doctor-status">
                <div class="doctor-status-badge status-preparing">On Call</div>
            </div>
        </div>`;
    } else if (doctors.length) {
        docList.innerHTML = doctors.map((doc, i) => {
            const statusCls = (doc.status||'').toLowerCase().includes('route')     ? 'status-en-route'
                            : (doc.status||'').toLowerCase().includes('available') ? 'status-available'
                            : 'status-preparing';
            return `
            <div class="doctor-card" style="animation:fadeUp 0.4s ease ${0.05*i}s forwards;opacity:0">
                <div class="doctor-card-scan"></div>
                <div class="doctor-avatar">${['üë®‚Äç‚öïÔ∏è','üë©‚Äç‚öïÔ∏è','üßë‚Äç‚öïÔ∏è'][i]||'üë®‚Äç‚öïÔ∏è'}<div class="doctor-online"></div></div>
                <div class="doctor-info">
                    <div class="doctor-name">${doc.name}</div>
                    <div class="doctor-specialty">${doc.specialty}</div>
                    <div class="doctor-meta">${doc.ward||''}</div>
                </div>
                <div class="doctor-status">
                    <div class="doctor-status-badge ${statusCls}">${doc.status}</div>
                    <div class="doctor-exp">${doc.experience||''}</div>
                </div>
            </div>`;
        }).join('');
    } else {
        docList.innerHTML = '<div class="no-data">Medical team being assigned‚Ä¶</div>';
    }

    /* ‚îÄ‚îÄ Hospitals ‚îÄ‚îÄ */
    const hospList = document.getElementById('hospitalList');
    if (d.hospitals && d.hospitals.length) {
        document.getElementById('hospCount').textContent = `${d.hospitals.length} Found`;
        hospList.innerHTML = d.hospitals.map((h, i) => {
            const distKm  = h.distance_km     ? Number(h.distance_km).toFixed(1)
                          : h.distance_meters ? (h.distance_meters/1000).toFixed(1) : '‚Äî';
            const beds    = parseInt(h.beds_available || h.available_beds || 0);
            const bedsCls = beds >= 8 ? 'beds-ok' : 'beds-low';
            const chosen  = h.chosen || (chosenHospitalName && h.name === chosenHospitalName);
            if (chosen) window._mapStartLabel = h.name; // update map label to actual chosen hospital
            return `
            <div class="hospital-row ${chosen ? 'chosen' : ''}" style="animation-delay:${i * 0.07}s">
                <div class="hosp-left">
                    <div class="hosp-rank">${chosen ? '‚òÖ' : i + 1}</div>
                    <div class="hosp-info">
                        <div class="hosp-name">${h.name}${chosen ? ' ‚úì' : ''}</div>
                        <div class="hosp-detail">${chosen ? 'üü¢ Bed Reserved' : `üìç ${distKm} km away`}</div>
                    </div>
                </div>
                <div class="hosp-right">
                    <div class="hosp-dist">${distKm} km</div>
                    <div class="hosp-beds ${bedsCls}">${beds > 0 ? (beds >= 8 ? beds+' beds' : beds+' left') : 'Reserved'}</div>
                </div>
            </div>`;
        }).join('');
    } else {
        hospList.innerHTML = '<div class="no-data">No hospital data available</div>';
    }

    /* ‚îÄ‚îÄ Show/hide click hint based on whether ambulance is already dispatched ‚îÄ‚îÄ */
    if (ambStep >= 2) {
        // Ambulance already dispatched ‚Äî show hint immediately
        document.getElementById('heroClickHint').style.display = 'flex';
    }

    /* ‚îÄ‚îÄ Poll /session-state every 15s for live status updates ‚îÄ‚îÄ */
    setInterval(async () => {
        try {
            const resp = await fetch('/session-state');
            if (!resp.ok) return;
            const srv = await resp.json();
            if (!srv.emergency) return;
            const em = srv.emergency;

            // Update ambulance status live
            const newStatus = em.ambulance_status || '';
            if (newStatus && newStatus !== document.getElementById('ambStatusValue').textContent) {
                document.getElementById('ambStatusValue').textContent = newStatus;
                document.getElementById('ambStatusTag').textContent   = newStatus;
                const newStep = ambStepMap[newStatus.toLowerCase()] || ambStep;
                document.getElementById('ambStatusSub').textContent = subMessages[newStep] || '';
            }
        } catch (_) {}
    }, 15000);

});
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AI EMERGENCY CALL SYSTEM + AMBULANCE MAP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RINGTONE ‚Äî generated via Web Audio API (no file needed)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let audioCtx = null;
let ringtoneNodes = [];
let ringtoneActive = false;

function createRingtone() {
    try {
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    } catch(e) { return null; }
}

function playRingtone() {
    const ctx = createRingtone();
    if (!ctx) return;
    ringtoneActive = true;

    function beep(startTime, duration) {
        const osc1 = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        const gain = ctx.createGain();

        osc1.type = 'sine'; osc1.frequency.value = 480;
        osc2.type = 'sine'; osc2.frequency.value = 620;

        osc1.connect(gain); osc2.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0, startTime);
        gain.gain.linearRampToValueAtTime(0.18, startTime + 0.05);
        gain.gain.setValueAtTime(0.18, startTime + duration - 0.05);
        gain.gain.linearRampToValueAtTime(0, startTime + duration);

        osc1.start(startTime); osc1.stop(startTime + duration);
        osc2.start(startTime); osc2.stop(startTime + duration);
        ringtoneNodes.push(osc1, osc2, gain);
    }

    const now = ctx.currentTime;
    // Two-tone phone ring pattern: beep, pause, beep, long pause √ó repeat
    for (let i = 0; i < 3; i++) {
        const t = now + i * 1.8;
        beep(t, 0.4);
        beep(t + 0.6, 0.4);
    }
}

function stopRingtone() {
    ringtoneActive = false;
    ringtoneNodes.forEach(n => { try { n.disconnect(); } catch(e) {} });
    ringtoneNodes = [];
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SPEECH SYNTHESIS HELPER
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let currentUtterance = null;

function speak(text, onEnd) {
    if (!window.speechSynthesis) { onEnd && onEnd(); return; }
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    currentUtterance = utter;
    utter.rate  = 0.88;
    utter.pitch = 1.0;

    // Pick en-IN voice if available
    const voices = window.speechSynthesis.getVoices();
    const indVoice = voices.find(v => v.lang === 'en-IN') ||
                     voices.find(v => v.lang.startsWith('en-IN')) ||
                     voices.find(v => v.lang.startsWith('en'));
    if (indVoice) utter.voice = indVoice;

    utter.onend = () => { onEnd && onEnd(); };
    utter.onerror = () => { onEnd && onEnd(); };
    window.speechSynthesis.speak(utter);
}

function stopSpeech() {
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    currentUtterance = null;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   TRANSCRIPT HELPER
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function addTranscriptLine(who, text) {
    const panel = document.getElementById('callTranscript');
    const line = document.createElement('div');
    line.className = 'tx-line';
    line.innerHTML = `<span class="tx-who tx-${who}">${who === 'ai' ? 'AI' : 'User'}</span><span class="tx-text">${text}</span>`;
    panel.appendChild(line);
    setTimeout(() => { panel.scrollTop = panel.scrollHeight; }, 50);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CALL STATE MANAGER
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function setCallState(state) {
    const badge = document.getElementById('callStateBadge');
    const text  = document.getElementById('callStateText');
    const wave  = document.getElementById('speakingWave');
    badge.className = `call-state-badge ${state}`;
    const labels = { dialing:'Dialing', ringing:'Ringing', connected:'Connected', speaking:'Speaking', confirmed:'Confirmed', completed:'Completed' };
    text.textContent = labels[state] || state;
    if (state === 'speaking') wave.classList.add('active');
    else wave.classList.remove('active');
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   INCIDENT LOG UPDATER
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function markIncident(index) {
    const entries = document.querySelectorAll('#incidentLog .inc-entry');
    if (entries[index]) {
        entries[index].classList.remove('pending');
        entries[index].querySelector('.inc-check').textContent = '‚úî';
        entries[index].style.color = 'var(--green)';
    }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   MAIN CALL FLOW
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let callInProgress = false;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SUMMARY HERO CLICK ‚Äî triggers call + map
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let summaryActivated = false;

function onSummaryClick() {
    if (summaryActivated) return;
    summaryActivated = true;

    // Hide the hint
    const hint = document.getElementById('heroClickHint');
    if (hint) hint.classList.add('hidden');

    // Remove cursor pointer from hero once activated
    const hero = document.getElementById('summaryHero');
    if (hero) { hero.style.cursor = 'default'; hero.onclick = null; }

    // Update map live tag
    const tag = document.getElementById('mapLiveTag');
    if (tag) { tag.textContent = '‚óè Live'; tag.className = 'section-tag tag-green'; }

    // Start the AI call ‚Äî map auto-starts inside endCall()
    startSimulatedCall();
}

function startSimulatedCall() {
    if (callInProgress) return;
    callInProgress = true;

    // Pre-load voices
    window.speechSynthesis && window.speechSynthesis.getVoices();

    const overlay = document.getElementById('callOverlay');
    const transcript = document.getElementById('callTranscript');
    transcript.innerHTML = '';

    overlay.classList.add('active');
    setCallState('dialing');
    markIncident(0);

    // Play ringtone
    playRingtone();

    // After 1s ‚Üí ringing
    setTimeout(() => {
        setCallState('ringing');
    }, 1000);

    // After 3s ‚Üí stop ringtone, connect
    setTimeout(() => {
        stopRingtone();
        setCallState('connected');

        // Step 1 ‚Äî after 0.5s
        setTimeout(() => {
            setCallState('speaking');
            const hospitalName = window._sessionHospital || 'the selected hospital';
            const locationName = window._sessionLocation || 'your location';
            const eta          = window._sessionEta      || 'shortly';

            const msg1 = "Hello. This is QwikAid emergency confirmation system.";
            addTranscriptLine('ai', msg1);
            speak(msg1, () => {
                // Pause 2s then step 2
                setTimeout(() => {
                    const msg2 = `An ambulance has been dispatched to ${locationName} and a bed has been reserved at ${hospitalName}.`;
                    addTranscriptLine('ai', msg2);
                    speak(msg2, () => {
                        // Pause 2s then step 3
                        setTimeout(() => {
                            const msg3 = "Please confirm that the patient is conscious and breathing.";
                            addTranscriptLine('ai', msg3);
                            speak(msg3, () => {
                                // Pause 3s ‚Äî auto user response
                                setTimeout(() => {
                                    addTranscriptLine('user', "Confirmed. Patient is stable and conscious.");
                                    setCallState('confirmed');
                                    markIncident(1);
                                    // Pause 2s then step 4
                                    setTimeout(() => {
                                        const msg4 = `Help is on the way. Estimated arrival in ${eta}. Stay calm. This call will now end.`;
                                        addTranscriptLine('ai', msg4);
                                        speak(msg4, () => {
                                            setTimeout(() => {
                                                setCallState('completed');
                                                markIncident(2);
                                                document.getElementById('endCallBtn').disabled = false;
                                                document.getElementById('endCallBtn').classList.add('ready');
                                                // Auto close after 3s
                                                setTimeout(() => endCall(), 3500);
                                            }, 500);
                                        });
                                    }, 2000);
                                }, 3000);
                            });
                        }, 2000);
                    });
                }, 2000);
            });
        }, 500);

    }, 3000);
}

function endCall() {
    const overlay = document.getElementById('callOverlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
        overlay.classList.remove('active');
        overlay.style.opacity = '';
        callInProgress = false;
        stopSpeech();
        // Continue workflow ‚Äî start map simulation
        mapControl('start');
    }, 600);
}

// ambulance_dispatched socket event support (external integrations)
document.addEventListener('ambulance_dispatched', () => {
    if (!summaryActivated) onSummaryClick();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AMBULANCE MAP SIMULATION ‚Äî SVG Canvas (no external APIs)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function() {

const canvas = document.getElementById('ambCanvas');
const ctx    = canvas.getContext('2d');

/* ‚îÄ‚îÄ Road waypoints (pixel coordinates on 600√ó400 canvas) ‚îÄ‚îÄ */
const BASE_W = 600, BASE_H = 380;
canvas.width  = BASE_W;
canvas.height = BASE_H;

// Route: Aakash Hospital (left) ‚Üí NSUT Delhi (right)
// Simulates Dwarka road network with turns
const WAYPOINTS = [
    {x: 72,  y: 290},  // Aakash Hospital
    {x: 120, y: 290},
    {x: 170, y: 260},
    {x: 230, y: 250},
    {x: 295, y: 250},
    {x: 350, y: 210},
    {x: 380, y: 175},
    {x: 420, y: 155},
    {x: 470, y: 148},
    {x: 528, y: 142},  // NSUT
];

const TOTAL_DIST_KM = 4.8; // realistic ~4.8 km
let animRunning  = false;
let animPaused   = false;
let progress     = 0;       // 0 ‚Üí total route length
let lastTime     = null;
let currentSpeed = 50;      // km/h
let animId       = null;
let arrived      = false;

/* Pre-compute cumulative segment lengths */
const segLengths = [];
let totalLen = 0;
for (let i = 1; i < WAYPOINTS.length; i++) {
    const dx = WAYPOINTS[i].x - WAYPOINTS[i-1].x;
    const dy = WAYPOINTS[i].y - WAYPOINTS[i-1].y;
    const l  = Math.sqrt(dx*dx + dy*dy);
    segLengths.push(l);
    totalLen += l;
}
const cumLen = [0];
for (let i = 0; i < segLengths.length; i++) cumLen.push(cumLen[i] + segLengths[i]);

/* Convert pixel progress to lat position on route */
function getPositionAtProgress(p) {
    const clamp = Math.min(Math.max(p, 0), totalLen);
    for (let i = 0; i < segLengths.length; i++) {
        if (clamp <= cumLen[i+1]) {
            const t = (clamp - cumLen[i]) / segLengths[i];
            return {
                x: WAYPOINTS[i].x + t * (WAYPOINTS[i+1].x - WAYPOINTS[i].x),
                y: WAYPOINTS[i].y + t * (WAYPOINTS[i+1].y - WAYPOINTS[i].y),
                angle: Math.atan2(
                    WAYPOINTS[i+1].y - WAYPOINTS[i].y,
                    WAYPOINTS[i+1].x - WAYPOINTS[i].x
                )
            };
        }
    }
    return { x: WAYPOINTS[WAYPOINTS.length-1].x, y: WAYPOINTS[WAYPOINTS.length-1].y, angle: 0 };
}

/* ‚îÄ‚îÄ Draw background map ‚îÄ‚îÄ */
function drawMap(scale) {
    const W = canvas.width, H = canvas.height;

    // Background ‚Äî dark city map
    ctx.fillStyle = '#0f1520';
    ctx.fillRect(0, 0, W, H);

    // City blocks / green patches
    const blocks = [
        {x:30,y:30,w:80,h:50,c:'#0d2010'},
        {x:180,y:40,w:60,h:40,c:'#0d2010'},
        {x:320,y:30,w:90,h:55,c:'#0d1d0d'},
        {x:460,y:25,w:100,h:45,c:'#0d2010'},
        {x:30,y:160,w:70,h:80,c:'#0d1a24'},
        {x:460,y:200,w:110,h:70,c:'#0d1a24'},
        {x:150,y:310,w:100,h:60,c:'#0d1a24'},
        {x:320,y:290,w:130,h:80,c:'#0d1a24'},
    ];
    blocks.forEach(b => {
        ctx.fillStyle = b.c;
        ctx.beginPath();
        ctx.roundRect(b.x, b.y, b.w, b.h, 4);
        ctx.fill();
        // subtle grid lines on block
        ctx.strokeStyle = 'rgba(255,255,255,0.025)';
        ctx.lineWidth = 0.5;
        for (let gx = b.x+16; gx < b.x+b.w; gx += 16) {
            ctx.beginPath(); ctx.moveTo(gx,b.y); ctx.lineTo(gx,b.y+b.h); ctx.stroke();
        }
        for (let gy = b.y+16; gy < b.y+b.h; gy += 16) {
            ctx.beginPath(); ctx.moveTo(b.x,gy); ctx.lineTo(b.x+b.w,gy); ctx.stroke();
        }
    });

    // Side streets (faint)
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 3;
    const sideStreets = [
        [[120,100],[120,290]],
        [[230,80],[230,250]],
        [[350,80],[350,210]],
        [[470,80],[470,148]],
        [[30,200],[600,200]],
    ];
    sideStreets.forEach(pts => {
        ctx.beginPath();
        ctx.moveTo(pts[0][0], pts[0][1]);
        ctx.lineTo(pts[1][0], pts[1][1]);
        ctx.stroke();
    });

    // Main roads (brighter)
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 7;
    ctx.beginPath();
    ctx.moveTo(0, 290); ctx.lineTo(600, 290); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, 148); ctx.lineTo(600, 148); ctx.stroke();
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(295, 0); ctx.lineTo(295, 380); ctx.stroke();

    /* ‚îÄ‚îÄ Route path ‚îÄ‚îÄ */
    // Glow pass
    ctx.shadowBlur = 12;
    ctx.shadowColor = 'rgba(245,158,11,0.4)';
    ctx.strokeStyle = 'rgba(245,158,11,0.25)';
    ctx.lineWidth = 8 * scale;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(WAYPOINTS[0].x, WAYPOINTS[0].y);
    WAYPOINTS.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
    ctx.stroke();

    // Main route line
    ctx.shadowBlur = 0;
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 4 * scale;
    ctx.setLineDash([10, 6]);
    ctx.beginPath();
    ctx.moveTo(WAYPOINTS[0].x, WAYPOINTS[0].y);
    WAYPOINTS.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
    ctx.stroke();
    ctx.setLineDash([]);
}

/* ‚îÄ‚îÄ Draw labels (uses dynamic names injected from session data) ‚îÄ‚îÄ */
function drawLabels(scale) {
    const startLabel = (window._mapStartLabel || 'Dispatching Hospital').slice(0, 28);
    const endLabel   = (window._mapEndLabel   || 'Your Location').slice(0, 28);

    // Start label
    const sp = WAYPOINTS[0];
    ctx.fillStyle = 'rgba(255,45,59,0.15)';
    ctx.strokeStyle = 'rgba(255,45,59,0.5)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(sp.x, sp.y, 8 * scale, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#ff2d3b';
    ctx.font = `bold ${10 * scale}px 'Space Grotesk', sans-serif`;
    ctx.fillText('üè• ' + startLabel, sp.x - 22, sp.y + 22 * scale);

    // End label
    const ep = WAYPOINTS[WAYPOINTS.length - 1];
    ctx.fillStyle = 'rgba(0,230,118,0.15)';
    ctx.strokeStyle = 'rgba(0,230,118,0.5)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(ep.x, ep.y, 8 * scale, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();
    ctx.shadowBlur = arrived ? 16 : 0;
    ctx.shadowColor = '#00e676';
    ctx.fillStyle = '#00e676';
    ctx.font = `bold ${10 * scale}px 'Space Grotesk', sans-serif`;
    ctx.fillText('üéØ ' + endLabel, ep.x - 36, ep.y - 14 * scale);
    ctx.shadowBlur = 0;
}

/* ‚îÄ‚îÄ Draw ambulance ‚îÄ‚îÄ */
function drawAmbulance(pos, scale) {
    ctx.save();
    ctx.translate(pos.x, pos.y);
    ctx.rotate(pos.angle);

    const w = 22 * scale, h = 14 * scale;

    // Glow
    ctx.shadowBlur = 18;
    ctx.shadowColor = 'rgba(255,255,255,0.6)';

    // Body
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.roundRect(-w/2, -h/2, w, h, 3);
    ctx.fill();

    ctx.shadowBlur = 0;

    // Red cross
    ctx.fillStyle = '#ff2d3b';
    ctx.fillRect(-3 * scale, -4 * scale, 6 * scale, 8 * scale);
    ctx.fillRect(-6 * scale, -2 * scale, 12 * scale, 4 * scale);

    // Siren flash
    const sirenOn = Math.floor(Date.now() / 250) % 2 === 0;
    ctx.fillStyle = sirenOn ? '#3b82f6' : '#ff2d3b';
    ctx.beginPath();
    ctx.arc(0, -h/2 - 3 * scale, 3 * scale, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
}

/* ‚îÄ‚îÄ Render frame ‚îÄ‚îÄ */
function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const scale = canvas.width / BASE_W;
    drawMap(scale);

    const pos = getPositionAtProgress(progress);
    drawAmbulance(pos, scale);
    drawLabels(scale);
}

/* ‚îÄ‚îÄ Animation loop ‚îÄ‚îÄ */
function animate(ts) {
    if (!animRunning || animPaused) return;

    if (lastTime === null) lastTime = ts;
    const dt = (ts - lastTime) / 1000; // seconds
    lastTime = ts;

    // Demo: finish in ~42 seconds total (visual demo speed)
    const demoSpeed = totalLen / 42;
    progress = Math.min(progress + demoSpeed * dt, totalLen);

    // Simulate realistic speed display based on demo progress
    if (Math.random() < 0.04) currentSpeed = 45 + Math.random() * 15;

    const distRemPx = Math.max(totalLen - progress, 0);
    const distRemKm = (distRemPx / totalLen) * TOTAL_DIST_KM;
    const etaSec    = currentSpeed > 0 ? (distRemKm / currentSpeed) * 3600 : 0;
    const etaMin    = Math.floor(etaSec / 60);
    const etaSecR   = Math.floor(etaSec % 60);

    document.getElementById('mapSpeed').textContent = Math.round(currentSpeed);
    document.getElementById('mapDist').textContent  = distRemKm.toFixed(2);
    document.getElementById('mapEta').textContent   = `${etaMin}:${String(etaSecR).padStart(2,'0')}`;

    if (progress >= totalLen) {
        arrived = true;
        animRunning = false;
        document.getElementById('mapStatusBadge').textContent = 'Arrived';
        document.getElementById('mapStatusBadge').className = 'map-status-badge arrived';
        const lt = document.getElementById('mapLiveTag');
        if (lt) { lt.textContent = '‚úî Arrived'; lt.className = 'section-tag tag-green'; }
        document.getElementById('mapSpeed').textContent = '0';
        document.getElementById('mapDist').textContent  = '0.00';
        document.getElementById('mapEta').textContent   = '0:00';
        render();
        return;
    }

    render();
    animId = requestAnimationFrame(animate);
}

window.mapControl = function(action) {
    if (action === 'start') {
        if (arrived) return;
        if (!animRunning) {
            animRunning = true;
            animPaused  = false;
            lastTime    = null;
            animId      = requestAnimationFrame(animate);
        } else if (animPaused) {
            animPaused = false;
            lastTime   = null;
            animId     = requestAnimationFrame(animate);
        }
    } else if (action === 'pause') {
        animPaused = true;
    }
};

// Responsive canvas sizing
function resizeCanvas() {
    const wrap = document.querySelector('.map-canvas-wrap');
    if (!wrap) return;
    const w = wrap.clientWidth;
    const h = Math.max(260, Math.min(380, w * 0.65));
    canvas.width  = w;
    canvas.height = h;
    // Rescale waypoints relative to new canvas size
    // We draw with scale factor: scale = w / BASE_W
    render();
}

window.addEventListener('resize', resizeCanvas);
setTimeout(resizeCanvas, 100);
render(); // Initial static render

})();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CHATBOT WIDGET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<style>
/* ‚îÄ‚îÄ‚îÄ FAB ‚îÄ‚îÄ‚îÄ */
.chat-fab{position:fixed;bottom:28px;right:28px;width:58px;height:58px;border-radius:50%;background:var(--red,#ff2d3b);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 6px 28px rgba(255,45,59,.45);z-index:8900;transition:transform .3s cubic-bezier(.34,1.56,.64,1),box-shadow .3s;animation:fabPulse 2.6s ease-in-out infinite;}
.chat-fab:hover{transform:scale(1.1);}
.chat-fab.open{animation:none;transform:scale(.92);}
@keyframes fabPulse{0%,100%{box-shadow:0 6px 28px rgba(255,45,59,.4);}50%{box-shadow:0 8px 44px rgba(255,45,59,.65),0 0 70px rgba(255,45,59,.15);}}
.fab-dot{position:absolute;top:4px;right:4px;width:11px;height:11px;border-radius:50%;background:#00e676;border:2px solid var(--bg,#0a0b0d);animation:blinkDot 1.8s ease-in-out infinite;}
@keyframes blinkDot{0%,100%{opacity:1;}50%{opacity:.25;}}
.fab-ico-chat{display:block}.fab-ico-x{display:none}
.chat-fab.open .fab-ico-chat{display:none}.chat-fab.open .fab-ico-x{display:block}

/* ‚îÄ‚îÄ‚îÄ WINDOW ‚îÄ‚îÄ‚îÄ */
.chat-win{position:fixed;bottom:100px;right:28px;width:370px;max-height:590px;background:var(--surface,#111318);border:1px solid rgba(255,255,255,.08);border-radius:22px;box-shadow:0 28px 90px rgba(0,0,0,.75),0 0 0 1px rgba(255,45,59,.05);display:flex;flex-direction:column;overflow:hidden;z-index:8899;transform-origin:bottom right;transform:scale(.85) translateY(20px);opacity:0;pointer-events:none;transition:transform .35s cubic-bezier(.34,1.56,.64,1),opacity .28s ease;}
.chat-win.show{transform:scale(1) translateY(0);opacity:1;pointer-events:all;}
.chat-win::before{content:'';display:block;height:2px;background:linear-gradient(90deg,var(--red,#ff2d3b),rgba(255,45,59,.25),transparent);flex-shrink:0;}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.cw-head{display:flex;align-items:center;gap:10px;padding:14px 16px 12px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.cw-ava{width:38px;height:38px;border-radius:11px;background:var(--red,#ff2d3b);display:flex;align-items:center;justify-content:center;font-size:19px;position:relative;flex-shrink:0;}
.cw-ava::after{content:'';position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;border-radius:50%;background:#00e676;border:2px solid var(--surface,#111318);animation:blinkDot 2s ease-in-out infinite;}
.cw-info{flex:1}
.cw-name{font-family:'Bebas Neue','Space Grotesk',sans-serif;font-size:15px;letter-spacing:.08em;color:var(--text,#f0f2f5);line-height:1;}
.cw-status{font-size:10px;font-weight:700;color:#00e676;letter-spacing:.08em;text-transform:uppercase;margin-top:2px;}
.cw-hbtn{width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);color:var(--muted,#6b7280);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;}
.cw-hbtn:hover{border-color:rgba(255,255,255,.15);color:var(--text,#f0f2f5);}

/* ‚îÄ‚îÄ‚îÄ QUICK CHIPS ‚îÄ‚îÄ‚îÄ */
.cw-chips{display:flex;gap:5px;flex-wrap:wrap;padding:9px 12px 7px;border-bottom:1px solid rgba(255,255,255,.04);flex-shrink:0;}
.cw-chip{padding:4px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--muted,#6b7280);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;font-family:'Space Grotesk',sans-serif;}
.cw-chip:hover{border-color:rgba(255,45,59,.45);color:var(--red,#ff2d3b);background:rgba(255,45,59,.06);}

/* ‚îÄ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ */
.cw-msgs{flex:1;overflow-y:auto;padding:12px 12px 4px;display:flex;flex-direction:column;gap:9px;scroll-behavior:smooth;}
.cw-msgs::-webkit-scrollbar{width:3px;}
.cw-msgs::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px;}
.cw-msg{display:flex;gap:7px;align-items:flex-end;animation:msgIn .28s ease forwards;opacity:0;}
.cw-msg.u{flex-direction:row-reverse;}
@keyframes msgIn{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.cw-mava{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.cw-mava.b{background:rgba(255,45,59,.1);border:1px solid rgba(255,45,59,.2);}
.cw-mava.u{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);}
.cw-bbl{max-width:80%;padding:9px 13px;border-radius:13px;font-size:13px;line-height:1.6;position:relative;}
.cw-bbl.b{background:var(--surface-2,#181c24);border:1px solid rgba(255,255,255,.07);color:var(--text,#f0f2f5);border-bottom-left-radius:3px;}
.cw-bbl.u{background:var(--red,#ff2d3b);color:#fff;border-bottom-right-radius:3px;box-shadow:0 4px 14px rgba(255,45,59,.3);}
.cw-bbl strong{color:var(--green,#00e676);}
.cw-bbl em{color:var(--amber,#f59e0b);font-style:normal;font-weight:600;}
.cw-time{font-size:9px;color:var(--muted-2,#4b5563);margin-top:3px;display:block;font-family:'JetBrains Mono',monospace;}

/* typing dots */
.cw-typing{display:flex;gap:4px;align-items:center;padding:4px 2px;}
.cw-typing span{width:6px;height:6px;border-radius:50%;background:var(--muted,#6b7280);animation:typeDot .9s ease-in-out infinite;}
.cw-typing span:nth-child(2){animation-delay:.15s;}
.cw-typing span:nth-child(3){animation-delay:.3s;}
@keyframes typeDot{0%,80%,100%{transform:scale(.8);opacity:.4;}40%{transform:scale(1.1);opacity:1;}}

/* ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ */
.cw-foot{display:flex;gap:8px;padding:10px 12px 14px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.cw-inp{flex:1;background:var(--surface-2,#181c24);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:9px 13px;font-size:13px;color:var(--text,#f0f2f5);font-family:'Space Grotesk',sans-serif;outline:none;transition:border-color .2s,box-shadow .2s;resize:none;max-height:80px;line-height:1.5;}
.cw-inp:focus{border-color:rgba(255,45,59,.45);box-shadow:0 0 0 3px rgba(255,45,59,.07);}
.cw-inp::placeholder{color:var(--muted-2,#4b5563);}
.cw-send{width:38px;height:38px;border-radius:10px;border:none;background:var(--red,#ff2d3b);color:#fff;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;align-self:flex-end;}
.cw-send:hover{background:#e8001a;transform:translateY(-1px);box-shadow:0 4px 14px rgba(255,45,59,.4);}
.cw-send:disabled{opacity:.4;cursor:not-allowed;transform:none;}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width:480px){
  .chat-win{width:calc(100vw - 24px);right:12px;bottom:88px;}
  .chat-fab{bottom:20px;right:16px;}
}
</style>

<!-- FAB Button -->
<button class="chat-fab" id="chatFab" aria-label="Open AI Assistant">
  <span class="fab-ico-chat">ü§ñ</span>
  <span class="fab-ico-x">‚úï</span>
  <span class="fab-dot"></span>
</button>

<!-- Chat Window -->
<div class="chat-win" id="chatWin">
  <div class="cw-head">
    <div class="cw-ava">üö®</div>
    <div class="cw-info">
      <div class="cw-name">EmergencyAI Assistant</div>
      <div class="cw-status">‚óè Online ‚Äî Always here</div>
    </div>
    <button class="cw-hbtn" id="chatClearBtn" title="Clear chat">üóë</button>
    <button class="cw-hbtn" id="chatCloseBtn" title="Close">‚úï</button>
  </div>

  <div class="cw-chips" id="chatChips"></div>
  <div class="cw-msgs"  id="chatMsgs"></div>

  <div class="cw-foot">
    <textarea class="cw-inp" id="chatInp" rows="1"
      placeholder="Ask anything about your emergency‚Ä¶"></textarea>
    <button class="cw-send" id="chatSend">‚û§</button>
  </div>
</div>

<script>
(function(){
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PAGE DETECTION ‚Äî determines which KB + chips to load
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PAGE = (function(){
  const p = window.location.pathname;
  if(p.includes('result'))    return 'result';
  if(p.includes('dashboard')) return 'dashboard';
  return 'form';
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PREDEFINED KNOWLEDGE BASE (no API needed for common Qs)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const KB = {
  form: [
    { q:['how does this work','what is this','explain'], a:`<strong>EmergencyAI</strong> is a rapid-response system.\n\n<em>Step 1</em> ‚Äî Describe your emergency & allow location access.\n<em>Step 2</em> ‚Äî Our AI triages your case and finds nearby hospitals.\n<em>Step 3</em> ‚Äî Select a hospital to instantly reserve a bed.\n\nAmbulance dispatch and doctor assignment happen automatically.` },
    { q:['location','gps','coordinates','allow location'], a:`Your location is detected via browser GPS for maximum accuracy. If blocked:\n\n‚Ä¢ Click <em>‚Ü∫ retry</em> after allowing access in your browser\n‚Ä¢ Or enter <em>Latitude / Longitude</em> manually in the fields below the location box\n\nYour coordinates are only used to find nearby hospitals ‚Äî never stored.` },
    { q:['triage','severity','score','assessed'], a:`Our AI triage engine analyzes your description and assigns:\n\n<strong>Severity Score</strong> ‚Äî 1 (mild) to 10 (life-threatening)\n<strong>Severity Level</strong> ‚Äî Low / Moderate / Critical\n<strong>Specialist</strong> ‚Äî Which doctor you need\n<strong>Department</strong> ‚Äî Which hospital wing to prepare\n\nHigher scores get faster response and priority routing.` },
    { q:['hospital','bed','reserve','select'], a:`We show the <strong>nearest hospitals</strong> with available beds, sorted by distance.\n\nClick <em>Reserve</em> on any hospital to instantly book a bed. The hospital is notified immediately and medical staff begin preparing for your arrival.` },
    { q:['ambulance','dispatch','transport'], a:`Once you reserve a bed, an ambulance is automatically dispatched to your GPS location.\n\nYou can track status on the <strong>Emergency Summary</strong> page:\n<em>Received ‚Üí Dispatched ‚Üí En Route ‚Üí Arrived</em>` },
    { q:['cost','bill','charge','price','fee'], a:`An <em>estimated bill</em> is shown after triage ‚Äî it's a rough range based on emergency type and hospital rates. Final billing happens at the hospital after treatment.\n\nAll costs shown are estimates only.` },
    { q:['emergency','help','urgent','call','911'], a:`‚ö†Ô∏è If this is a <strong>life-threatening emergency</strong>, call <em>112</em> (India) immediately alongside using this form.\n\nThis system is designed to <strong>speed up hospital arrival</strong> by pre-reserving a bed and dispatching an ambulance ‚Äî but for cardiac arrest or major trauma, also call emergency services.` },
    { q:['what to type','describe','message','explain emergency'], a:`Be as specific as possible. Include:\n\n‚Ä¢ <em>What happened</em> (e.g. "chest pain", "road accident")\n‚Ä¢ <em>Patient age</em> and gender if possible\n‚Ä¢ <em>Duration</em> of symptoms\n‚Ä¢ <em>Any known conditions</em> (diabetes, heart disease‚Ä¶)\n\nExample: <strong>"55-year-old male, severe chest pain radiating to left arm, started 20 mins ago, history of hypertension"</strong>` },
  ],

  result: [
    { q:['reference','ref','id','case number'], a:`Your <strong>Reference Number</strong> (e.g. EMG-8847) is shown at the top of this page. Share it with hospital staff on arrival ‚Äî they use it to pull up your pre-registered case instantly.` },
    { q:['severity','score','critical','moderate','low'], a:`Severity levels explained:\n\n<strong>Critical (7‚Äì10)</strong> ‚Äî Life-threatening. Immediate intervention required. ICU/resus team alerted.\n<strong>Moderate (4‚Äì6)</strong> ‚Äî Urgent but stable. Priority queue at ER.\n<em>Low (1‚Äì3)</em> ‚Äî Non-emergency. Standard ER queue.` },
    { q:['ambulance','status','en route','dispatched','eta'], a:`The ambulance dispatch panel shows real-time status:\n\n<em>Received</em> ‚Üí Alert logged in dispatch system\n<em>Dispatched</em> ‚Üí Ambulance assigned & departing\n<em>En Route</em> ‚Üí Ambulance heading to your location\n<em>Arrived</em> ‚Üí Team on scene\n\nETA is estimated based on distance and traffic.` },
    { q:['doctor','physician','specialist','assigned'], a:`The <strong>Assigned Medical Team</strong> section shows doctors preparing for your arrival.\n\nStatus badges mean:\n<em>Preparing</em> ‚Äî In hospital, reading your case\n<em>En Route</em> ‚Äî Traveling to the hospital\n<em>Available</em> ‚Äî Ready and waiting for you` },
    { q:['hospital','bed','reserved','which hospital'], a:`Your chosen hospital is marked with ‚úì in the hospitals section. The bed is <strong>reserved and held</strong> for you ‚Äî staff have been notified and the department is preparing.\n\nBring your Reference Number on arrival.` },
    { q:['bill','cost','estimate','payment'], a:`The estimated bill is a <em>pre-arrival estimate</em> based on your emergency type and typical hospital rates. Final charges depend on:\n\n‚Ä¢ Actual treatment required\n‚Ä¢ Medications and procedures\n‚Ä¢ Duration of stay\n\nArrange payment/insurance at the hospital's billing counter.` },
    { q:['new emergency','start over','another'], a:`To submit a new emergency, click <strong>"Submit New Emergency ‚Üí"</strong> at the bottom of this page, or go back to the home page. Your current case will remain in the system for doctors to manage.` },
    { q:['dashboard','doctor','view'], a:`The <strong>Doctor Dashboard</strong> shows all active cases in real time. Doctors use it to accept cases, track ambulance status, and mark cases complete.\n\nClick "View Doctor Dashboard ‚Üí" to see your case from the medical team's perspective.` },
  ],

  dashboard: [
    { q:['accept','how to accept','take case'], a:`To accept a case, click the <strong>üöë Accept</strong> button on any card with <em>Bed Reserved</em> status.\n\nThis:\n‚Ä¢ Triggers ambulance dispatch via the dispatch agent\n‚Ä¢ Changes status to <em>En Route</em>\n‚Ä¢ Notifies the patient's result page in real time` },
    { q:['complete','finish','close case'], a:`Click <strong>‚úì Complete</strong> on any <em>En Route</em> case when the patient has arrived and been admitted.\n\nThis:\n‚Ä¢ Frees the reserved bed (bed counter decrements)\n‚Ä¢ Changes status to <em>Completed</em>\n‚Ä¢ Removes the case from active queue` },
    { q:['filter','search','find case'], a:`Use the filter buttons to narrow cases:\n<em>All</em> ‚Äî every active case\n<em>Reserved</em> ‚Äî awaiting acceptance\n<em>En Route</em> ‚Äî ambulance dispatched\n<em>Completed</em> ‚Äî resolved cases\n<em>‚ö° Critical</em> ‚Äî severity 7‚Äì10 only\n\nOr use the <strong>search box</strong> to find by patient name, case ID, or location.` },
    { q:['stats','numbers','count','total'], a:`The four stat cards at the top update live:\n\n<strong>Total Cases</strong> ‚Äî all submissions today\n<strong>Bed Reserved</strong> ‚Äî awaiting doctor acceptance\n<strong>En Route</strong> ‚Äî ambulance dispatched, patient incoming\n<strong>Completed</strong> ‚Äî resolved today` },
    { q:['ambulance','dispatch','driver'], a:`Each case card shows the <strong>assigned ambulance</strong> (ID + driver name + plate number) and its current status.\n\nStatuses: <em>Dispatched ‚Üí En Route ‚Üí Arrived</em>\n\nThe ETA pill blinks red when under 10 minutes away.` },
    { q:['severity','critical','urgent','priority'], a:`Cases are color-coded by severity:\n\nüî¥ <strong>Critical</strong> ‚Äî Red accent bar, card pulses. Accept immediately.\nüü° <strong>Moderate</strong> ‚Äî Amber accent bar. Urgent but stable.\nüü¢ <em>Low</em> ‚Äî Green accent bar. Non-critical.\n\nCritical cards animate continuously as a visual alert.` },
    { q:['refresh','update','live','real time'], a:`The dashboard <strong>auto-refreshes every 30 seconds</strong>. New cases pop in with a cyan flash animation.\n\nClick the <em>‚Üª refresh button</em> in the top bar to force an immediate update. The timestamp shows last sync time.` },
    { q:['specialist','department','doctor'], a:`Each case card shows the:\n‚Ä¢ <em>Required Specialist</em> ‚Äî e.g. Cardiologist, Trauma Surgeon\n‚Ä¢ <em>Department</em> ‚Äî e.g. ICU, ER, Neurology\n‚Ä¢ <em>Assigned Doctor</em> ‚Äî name, specialty, and preparation status\n\nThis helps the correct team prepare before the patient arrives.` },
  ]
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QUICK CHIPS PER PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CHIPS = {
  form:      ['How does this work?', 'What to type?', 'Location issues', 'Ambulance info', 'Cost estimate'],
  result:    ['What\'s my ref #?', 'Ambulance status', 'Doctor assigned?', 'Which hospital?', 'Cost estimate'],
  dashboard: ['How to accept?', 'Filter cases', 'Stats explained', 'Severity levels', 'Auto-refresh'],
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WELCOME MESSAGE PER PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WELCOME = {
  form:      `üëã Hi! I'm your <strong>EmergencyAI Assistant</strong>.\n\nI can help you with:\n‚Ä¢ Filling in the emergency form\n‚Ä¢ Understanding triage & severity\n‚Ä¢ Location & hospital questions\n‚Ä¢ Ambulance & cost info\n\nWhat do you need help with?`,
  result:    `üëã Hello! I'm here to help you understand your <strong>Emergency Summary</strong>.\n\nAsk me about your:\n‚Ä¢ Reference number & case status\n‚Ä¢ Ambulance dispatch & ETA\n‚Ä¢ Assigned doctors & hospital\n‚Ä¢ Estimated bill\n\nHow can I assist?`,
  dashboard: `üëã Welcome, Doctor! I'm your <strong>Dashboard Assistant</strong>.\n\nI can help with:\n‚Ä¢ Accepting & completing cases\n‚Ä¢ Understanding severity levels\n‚Ä¢ Filtering & searching cases\n‚Ä¢ Dispatch & ambulance info\n\nWhat do you need?`,
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FALLBACK ANSWERS for unmatched questions
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const FALLBACK = [
  `I don't have a specific answer for that, but I'm trained on all EmergencyAI features.\n\nTry asking about:\n‚Ä¢ <em>Triage & severity scores</em>\n‚Ä¢ <em>Hospital bed reservation</em>\n‚Ä¢ <em>Ambulance dispatch</em>\n‚Ä¢ <em>Cost estimates</em>\n\nOr rephrase your question!`,
  `That's outside my knowledge base for this page. Try one of the quick-action chips above for common questions, or ask about ambulances, hospitals, doctors, or costs.`,
  `I'm specialized in EmergencyAI workflows. For that specific query, please contact hospital support directly.\n\nI <em>can</em> help with anything on this page ‚Äî triage, dispatch, bed reservations, or doctor assignments.`,
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let chatHistory = [];
let isTyping    = false;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOM REFS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const fab      = document.getElementById('chatFab');
const win      = document.getElementById('chatWin');
const msgsEl   = document.getElementById('chatMsgs');
const inpEl    = document.getElementById('chatInp');
const sendBtn  = document.getElementById('chatSend');
const chipsEl  = document.getElementById('chatChips');
const clearBtn = document.getElementById('chatClearBtn');
const closeBtn = document.getElementById('chatCloseBtn');

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT CHIPS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(CHIPS[PAGE] || CHIPS.form).forEach(txt => {
  const c = document.createElement('button');
  c.className   = 'cw-chip';
  c.textContent = txt;
  c.onclick     = () => sendMessage(txt);
  chipsEl.appendChild(c);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOGGLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
fab.onclick = () => {
  const opening = !win.classList.contains('show');
  fab.classList.toggle('open', opening);
  win.classList.toggle('show', opening);
  if (opening && msgsEl.children.length === 0) {
    addBotMsg(WELCOME[PAGE] || WELCOME.form);
  }
  if (opening) setTimeout(() => inpEl.focus(), 350);
};
closeBtn.onclick = () => { fab.classList.remove('open'); win.classList.remove('show'); };
clearBtn.onclick = () => {
  chatHistory = [];
  msgsEl.innerHTML = '';
  addBotMsg(WELCOME[PAGE] || WELCOME.form);
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function nowTime(){
  return new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
}

function addBotMsg(html, skipHistory){
  const wrap = document.createElement('div');
  wrap.className = 'cw-msg';
  wrap.innerHTML = `
    <div class="cw-mava b">üö®</div>
    <div>
      <div class="cw-bbl b">${html.replace(/\n/g,'<br>')}</div>
      <span class="cw-time">${nowTime()}</span>
    </div>`;
  msgsEl.appendChild(wrap);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  if(!skipHistory) chatHistory.push({role:'assistant', content: html.replace(/<[^>]+>/g,'')});
}

function addUserMsg(text){
  const wrap = document.createElement('div');
  wrap.className = 'cw-msg u';
  wrap.innerHTML = `
    <div class="cw-mava u">üë§</div>
    <div>
      <div class="cw-bbl u">${escHtml(text)}</div>
      <span class="cw-time" style="text-align:right">${nowTime()}</span>
    </div>`;
  msgsEl.appendChild(wrap);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  chatHistory.push({role:'user', content: text});
}

function showTyping(){
  const el = document.createElement('div');
  el.className = 'cw-msg';
  el.id = 'chatTyping';
  el.innerHTML = `<div class="cw-mava b">üö®</div><div class="cw-bbl b"><div class="cw-typing"><span></span><span></span><span></span></div></div>`;
  msgsEl.appendChild(el);
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

function hideTyping(){
  const el = document.getElementById('chatTyping');
  if(el) el.remove();
}

function escHtml(t){
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KB MATCH ‚Äî check predefined answers first
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function matchKB(text){
  const lower = text.toLowerCase();
  const kb     = KB[PAGE] || KB.form;
  for(const entry of kb){
    if(entry.q.some(kw => lower.includes(kw))) return entry.a;
  }
  // cross-page general matches
  for(const page of Object.values(KB)){
    for(const entry of page){
      if(entry.q.some(kw => lower.includes(kw))) return entry.a;
    }
  }
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANTHROPIC API CALL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function callAnthropicAPI(userText){
  const pageCtx = {
    form:      'The user is on the Emergency Form page where they describe their emergency, get triaged, and select a hospital to reserve a bed.',
    result:    'The user is on the Emergency Summary/Result page showing triage data, ambulance dispatch status, assigned doctors, and nearby hospitals.',
    dashboard: 'The user is a doctor viewing the Doctor Dashboard which shows all active emergency cases with accept/complete actions.',
  }[PAGE];

  const systemPrompt = `You are EmergencyAI Assistant, an expert helper for the EmergencyAI rapid-response medical system built with Flask/Python backend.
${pageCtx}

Answer questions about: emergency forms, triage & severity scores, hospital bed reservation, ambulance dispatch, doctor assignment, cost estimates, and dashboard operations.
Keep responses concise (under 120 words), practical, and use simple formatting.
Never make up medical advice ‚Äî stick to how the system works.
If asked something unrelated, redirect politely to EmergencyAI features.`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 300,
      system: systemPrompt,
      messages: [
        ...chatHistory.slice(-6).map(m => ({role: m.role, content: m.content})),
        {role: 'user', content: userText}
      ]
    })
  });

  if(!response.ok) throw new Error('API error');
  const data = await response.json();
  return data.content?.[0]?.text || 'Sorry, I could not generate a response.';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEND MESSAGE ‚Äî KB first, API fallback
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sendMessage(text){
  text = text.trim();
  if(!text || isTyping) return;

  addUserMsg(text);
  inpEl.value = '';
  inpEl.style.height = '';
  isTyping = true;
  sendBtn.disabled = true;

  showTyping();

  // Small realistic delay
  await new Promise(r => setTimeout(r, 450 + Math.random()*400));

  // 1. Try KB match
  const kbAnswer = matchKB(text);
  if(kbAnswer){
    hideTyping();
    addBotMsg(kbAnswer);
    isTyping = false;
    sendBtn.disabled = false;
    return;
  }

  // 2. Try Anthropic API
  try {
    const apiAnswer = await callAnthropicAPI(text);
    hideTyping();
    addBotMsg(apiAnswer);
  } catch(_){
    // 3. Fallback
    hideTyping();
    const fb = FALLBACK[Math.floor(Math.random() * FALLBACK.length)];
    addBotMsg(fb);
  }

  isTyping = false;
  sendBtn.disabled = false;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INPUT HANDLERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
sendBtn.onclick = () => sendMessage(inpEl.value);

inpEl.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage(inpEl.value);
  }
});

// Auto-resize textarea
inpEl.addEventListener('input', () => {
  inpEl.style.height = '';
  inpEl.style.height = Math.min(inpEl.scrollHeight, 80) + 'px';
});

})();
</script>

</body>
</html>