<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmergencyAI â€” Emergency Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Bebas+Neue&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --red:        #ff2d3b;
            --red-glow:   rgba(255, 45, 59, 0.25);
            --red-dim:    rgba(255, 45, 59, 0.08);
            --bg:         #0a0b0d;
            --surface:    #111318;
            --surface-2:  #181c24;
            --border:     rgba(255,255,255,0.07);
            --border-hi:  rgba(255,255,255,0.14);
            --text:       #f0f2f5;
            --muted:      #6b7280;
            --muted-2:    #4b5563;
            --green:      #00e676;
            --green-dim:  rgba(0,230,118,0.08);
            --blue:       #3b82f6;
            --blue-dim:   rgba(59,130,246,0.08);
            --amber:      #f59e0b;
            --amber-dim:  rgba(245,158,11,0.08);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 32px 16px 100px;
            overflow-x: hidden;
        }

        /* â”€â”€ Animated Background â”€â”€ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 60% 50% at 20% -10%, rgba(255,45,59,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 40% 40% at 80% 110%, rgba(59,130,246,0.07) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* â”€â”€ Pulse dot animations â”€â”€ */
        @keyframes pulseRing {
            0%   { transform: scale(1);   opacity: 0.8; }
            100% { transform: scale(2.4); opacity: 0; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.3; }
        }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes slideRight {
            from { transform: scaleX(0); }
            to   { transform: scaleX(1); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes shimmer {
            0%   { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        @keyframes bounceIn {
            0%   { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            60%  { transform: scale(1.15) rotate(3deg); }
            80%  { transform: scale(0.95) rotate(-1deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--red-glow); }
            50%       { box-shadow: 0 0 40px rgba(255,45,59,0.4), 0 0 80px rgba(255,45,59,0.15); }
        }
        @keyframes confettiFall {
            to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
        @keyframes lineProgress {
            from { width: 0; }
            to   { width: 100%; }
        }

        /* Staggered card entrance */
        .animate-up {
            opacity: 0;
            animation: fadeUp 0.5s ease forwards;
        }

        /* â”€â”€ Header â”€â”€ */
        .page-header {
            max-width: 620px;
            margin: 0 auto 36px;
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            z-index: 1;
            animation: fadeUp 0.6s ease 0.1s forwards;
            opacity: 0;
        }

        .logo-mark {
            position: relative;
            width: 48px; height: 48px;
            border-radius: 14px;
            background: var(--red);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            box-shadow: 0 0 0 0 var(--red-glow);
            animation: glow 2.5s ease-in-out infinite;
        }
        .logo-mark::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 18px;
            border: 1.5px solid rgba(255,45,59,0.3);
            animation: pulseRing 2s ease-out infinite;
        }
        .logo-mark::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 18px;
            border: 1.5px solid rgba(255,45,59,0.2);
            animation: pulseRing 2s ease-out 0.7s infinite;
        }

        .header-text { flex: 1; }
        .page-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            letter-spacing: 0.08em;
            color: var(--text);
            line-height: 1;
        }
        .page-title span { color: var(--red); }
        .page-subtitle {
            font-size: 11px;
            color: var(--muted);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-top: 3px;
            font-weight: 500;
        }

        /* Live indicator */
        .live-badge {
            display: flex; align-items: center; gap: 6px;
            padding: 5px 12px;
            border-radius: 999px;
            background: rgba(0,230,118,0.08);
            border: 1px solid rgba(0,230,118,0.2);
            font-size: 11px;
            font-weight: 600;
            color: var(--green);
            letter-spacing: 0.1em;
        }
        .live-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--green);
            animation: blink 1.4s ease-in-out infinite;
        }

        /* â”€â”€ Step Pills â”€â”€ */
        .steps {
            max-width: 620px;
            margin: 0 auto 28px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
            animation: fadeUp 0.6s ease 0.2s forwards;
            opacity: 0;
        }

        .step-pill {
            display: flex; align-items: center; gap: 8px;
            font-size: 11px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            color: var(--muted);
            padding: 7px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            white-space: nowrap;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .step-pill .pill-num {
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--surface-2);
            display: flex; align-items: center; justify-content: center;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        .step-pill.active {
            color: var(--red);
            border-color: rgba(255,45,59,0.4);
            background: var(--red-dim);
            box-shadow: 0 0 20px rgba(255,45,59,0.1);
        }
        .step-pill.active .pill-num {
            background: var(--red);
            color: white;
            border-color: var(--red);
            box-shadow: 0 0 10px var(--red-glow);
        }
        .step-pill.done {
            color: var(--green);
            border-color: rgba(0,230,118,0.3);
            background: var(--green-dim);
        }
        .step-pill.done .pill-num {
            background: var(--green);
            color: #0a0b0d;
            border-color: var(--green);
        }
        .step-connector {
            flex: 1;
            height: 1px;
            background: var(--border);
            position: relative;
            overflow: hidden;
        }
        .step-connector::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, var(--red), transparent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s ease;
        }
        .connector-done::after { transform: scaleX(1); }

        /* â”€â”€ Container â”€â”€ */
        .container { max-width: 620px; margin: 0 auto; position: relative; z-index: 1; }

        /* â”€â”€ Card â”€â”€ */
        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 40px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
        }
        .card:hover {
            box-shadow: 0 12px 50px rgba(0,0,0,0.5);
        }

        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 18px;
            letter-spacing: 0.1em;
            margin-bottom: 20px;
            color: var(--text);
            display: flex; align-items: center; gap: 10px;
        }
        .card-title .icon {
            width: 36px; height: 36px;
            border-radius: 10px;
            background: var(--red-dim);
            border: 1px solid rgba(255,45,59,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 17px;
        }

        /* â”€â”€ Form Elements â”€â”€ */
        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .form-textarea {
            width: 100%;
            padding: 16px 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 15px;
            color: var(--text);
            resize: none;
            min-height: 90px;
            transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
            background: var(--surface-2);
            line-height: 1.6;
        }
        .form-textarea:focus {
            outline: none;
            border-color: rgba(255,45,59,0.5);
            box-shadow: 0 0 0 3px rgba(255,45,59,0.08), 0 0 20px rgba(255,45,59,0.05);
            background: #13171f;
        }
        .form-textarea::placeholder { color: var(--muted-2); }

        /* â”€â”€ Location Box â”€â”€ */
        #locBox {
            margin-top: 14px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 13px;
            transition: border-color 0.3s, background 0.3s, box-shadow 0.3s;
        }
        #locBox.loc-ready  { 
            border-color: rgba(0,230,118,0.3); 
            background: rgba(0,230,118,0.04);
            box-shadow: 0 0 20px rgba(0,230,118,0.05);
        }
        #locBox.loc-error  { 
            border-color: rgba(245,158,11,0.3); 
            background: rgba(245,158,11,0.04); 
        }
        .loc-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .loc-icon { font-size: 20px; flex-shrink: 0; }
        .loc-text { flex: 1; min-width: 0; }
        .loc-header { font-weight: 600; color: var(--text); font-size: 13px; }
        .loc-details { 
            color: var(--muted); 
            font-size: 11px; 
            margin-top: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-family: 'JetBrains Mono', monospace;
        }
        #retryLocBtn {
            font-size: 16px;
            width: 34px; height: 34px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            color: var(--muted);
            transition: all 0.25s ease;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        #retryLocBtn:hover { border-color: var(--red); color: var(--red); transform: rotate(-45deg); }

        .manual-label {
            font-size: 11px; font-weight: 600;
            color: var(--muted); margin: 12px 0 8px;
            letter-spacing: 0.08em; text-transform: uppercase;
        }
        .manual-row { display: flex; gap: 8px; }
        .manual-row input {
            flex: 1;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--surface);
            color: var(--text);
            min-width: 0;
            transition: border-color 0.2s;
        }
        .manual-row input:focus { outline: none; border-color: var(--blue); }
        .manual-row input::placeholder { color: var(--muted-2); }
        #manualLocBtn {
            padding: 9px 16px;
            border-radius: 8px;
            border: none;
            background: var(--blue);
            color: white;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 12px; font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            letter-spacing: 0.05em;
        }
        #manualLocBtn:hover { background: #2563eb; transform: translateY(-1px); }

        /* â”€â”€ Submit Button â”€â”€ */
        #submitBtn {
            width: 100%;
            margin-top: 18px;
            padding: 17px;
            background: var(--surface-2);
            color: var(--muted);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 0.1em;
            cursor: not-allowed;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        #submitBtn.btn-ready {
            background: var(--red);
            color: white;
            border-color: var(--red);
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(255,45,59,0.3), 0 0 60px rgba(255,45,59,0.1);
        }
        #submitBtn.btn-ready::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; right: -100%; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
            animation: shimmer 2.5s linear infinite;
            background-size: 200% auto;
        }
        #submitBtn.btn-ready:hover {
            background: #e8001a;
            transform: translateY(-2px);
            box-shadow: 0 14px 40px rgba(255,45,59,0.4), 0 0 80px rgba(255,45,59,0.15);
        }
        #submitBtn.btn-ready:active { transform: translateY(0); }
        #submitBtn:disabled { opacity: 0.5; }

        /* â”€â”€ Loader â”€â”€ */
        #loader {
            text-align: center;
            padding: 40px 20px;
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.4);
        }
        .loader-inner {
            display: flex; flex-direction: column;
            align-items: center; gap: 20px;
        }
        .pulse-ring-wrap {
            position: relative;
            width: 60px; height: 60px;
        }
        .pulse-ring {
            width: 60px; height: 60px;
            border: 2px solid rgba(255,45,59,0.15);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }
        .pulse-ring-inner {
            position: absolute;
            inset: 10px;
            border: 2px solid rgba(255,45,59,0.1);
            border-bottom-color: rgba(255,45,59,0.5);
            border-radius: 50%;
            animation: spin 1.4s linear infinite reverse;
        }
        .loader-inner .loader-text {
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            letter-spacing: 0.05em;
        }
        .loader-inner .loader-subtext {
            font-size: 11px;
            color: var(--muted-2);
            font-family: 'JetBrains Mono', monospace;
            animation: blink 1.8s ease-in-out infinite;
        }

        /* â”€â”€ Triage â”€â”€ */
        .triage-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .triage-item {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            transition: border-color 0.2s;
        }
        .triage-item:hover { border-color: var(--border-hi); }
        .triage-label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            margin-bottom: 5px;
        }
        .triage-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }
        .severity-row {
            display: flex; align-items: center; gap: 8px;
        }
        .score-num {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 20px;
            letter-spacing: 0.05em;
        }
        .severity-bar-wrap {
            margin-top: 10px;
            height: 3px;
            background: var(--surface-2);
            border-radius: 2px;
            overflow: hidden;
        }
        .severity-bar {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--green), var(--amber), var(--red));
            transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* â”€â”€ Badges â”€â”€ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .badge-critical { background: rgba(255,45,59,0.15); color: var(--red); border: 1px solid rgba(255,45,59,0.3); }
        .badge-moderate { background: rgba(245,158,11,0.15); color: var(--amber); border: 1px solid rgba(245,158,11,0.3); }
        .badge-low      { background: rgba(0,230,118,0.12); color: var(--green); border: 1px solid rgba(0,230,118,0.25); }

        /* â”€â”€ Hospitals â”€â”€ */
        .hospital-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 18px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.25s ease;
            animation: fadeUp 0.4s ease forwards;
            opacity: 0;
            background: var(--surface-2);
            cursor: pointer;
        }
        .hospital-card:hover { 
            border-color: rgba(59,130,246,0.4); 
            box-shadow: 0 4px 20px rgba(59,130,246,0.08);
            transform: translateX(2px);
        }
        .hospital-card.selected {
            border-color: rgba(59,130,246,0.5);
            background: var(--blue-dim);
            box-shadow: 0 0 30px rgba(59,130,246,0.1);
        }
        .hospital-card.dimmed { opacity: 0.25; pointer-events: none; }
        .hosp-info { display: flex; flex-direction: column; gap: 4px; }
        .hosp-name { font-weight: 600; font-size: 14px; color: var(--text); }
        .hosp-dist { 
            font-size: 11px; 
            color: var(--muted); 
            font-family: 'JetBrains Mono', monospace;
        }
        .btn-select {
            padding: 9px 20px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 12px; font-weight: 700;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        .btn-select:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(59,130,246,0.3); }
        .btn-select:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .no-data { color: var(--muted); font-size: 14px; padding: 14px 0; }

        /* â”€â”€ Confirmation â”€â”€ */
        .confirm-icon {
            font-size: 56px;
            text-align: center;
            margin-bottom: 14px;
            animation: bounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .confirm-title {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 28px;
            letter-spacing: 0.08em;
            text-align: center;
            color: var(--green);
            margin-bottom: 24px;
            text-shadow: 0 0 40px rgba(0,230,118,0.3);
        }
        .confirm-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .confirm-item {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .confirm-label {
            display: block;
            font-size: 10px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
        }
        .confirm-val {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 22px;
            letter-spacing: 0.05em;
        }
        .confirm-note {
            text-align: center;
            font-size: 13px;
            color: var(--muted);
            line-height: 1.7;
        }
        .confirm-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 24px;
        }
        .confirm-links a {
            display: block;
            text-align: center;
            padding: 13px;
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.25s ease;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        .link-dash {
            background: var(--blue-dim);
            color: var(--blue);
            border: 1px solid rgba(59,130,246,0.25);
        }
        .link-dash:hover { background: var(--blue); color: white; box-shadow: 0 4px 20px rgba(59,130,246,0.3); }
        .link-result {
            background: var(--surface-2);
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .link-result:hover { border-color: var(--border-hi); color: var(--text); }

        /* â”€â”€ Toast â”€â”€ */
        .toast {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--surface-2);
            color: var(--text);
            padding: 13px 22px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 360px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid var(--border-hi);
        }
        .toast-show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-error   { background: rgba(255,45,59,0.15); border-color: rgba(255,45,59,0.3); color: #ff6b75; }
        .toast-warn    { background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25); color: var(--amber); }
        .toast-success { background: rgba(0,230,118,0.1); border-color: rgba(0,230,118,0.25); color: var(--green); }
        .toast-info    { background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.25); color: var(--blue); }

        /* â”€â”€ Session Restore Banner â”€â”€ */
        .restore-banner {
            display: flex; align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: var(--blue-dim);
            border: 1px solid rgba(59,130,246,0.25);
            border-radius: 14px;
            padding: 13px 18px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--blue);
            animation: fadeUp 0.4s ease forwards;
            position: relative; z-index: 1;
        }
        .restore-banner button {
            padding: 6px 16px;
            border-radius: 8px;
            border: 1px solid rgba(59,130,246,0.4);
            background: transparent;
            color: var(--blue);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px; font-weight: 700;
            cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .restore-banner button:hover { background: var(--blue); color: white; }

        /* â”€â”€ Confetti â”€â”€ */
        .confetti-piece {
            position: fixed; top: -10px;
            pointer-events: none;
            animation: confettiFall linear forwards;
        }

        /* â”€â”€ Divider â”€â”€ */
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 18px 0;
        }

        .hidden { display: none !important; }

        @media (max-width: 480px) {
            .triage-grid { grid-template-columns: 1fr; }
            .confirm-grid { grid-template-columns: 1fr; }
            .restore-banner { flex-direction: column; align-items: flex-start; }
            .steps { gap: 4px; }
            .step-pill { padding: 6px 10px; font-size: 10px; }
        }
    </style>
</head>
<body>

<header class="page-header">
    <div class="logo-mark">ğŸš¨</div>
    <div class="header-text">
        <div class="page-title"><span>Emergency</span>AI</div>
        <div class="page-subtitle">Rapid Response System</div>
    </div>
    <div class="live-badge"><span class="live-dot"></span> LIVE</div>
</header>

<div class="steps">
    <div class="step-pill active" id="pill1"><span class="pill-num">1</span> Triage</div>
    <div class="step-connector" id="conn1"></div>
    <div class="step-pill" id="pill2"><span class="pill-num">2</span> Hospital</div>
    <div class="step-connector" id="conn2"></div>
    <div class="step-pill" id="pill3"><span class="pill-num">3</span> Confirmed</div>
</div>

<div class="container">

    <!-- STEP 1: Form -->
    <div class="card animate-up" id="formSection" style="animation-delay:0.3s">
        <div class="card-title">
            <div class="icon">ğŸ“‹</div>
            Describe the Emergency
        </div>
        <label class="form-label" for="message">What's happening?</label>
        <textarea class="form-textarea" id="message" rows="3"
                  placeholder="e.g. Severe chest pain and difficulty breathing, patient is 55 years oldâ€¦"></textarea>

        <div id="locBox">
            <div class="loc-row">
                <span class="loc-icon" id="locIcon">â³</span>
                <div class="loc-text">
                    <div class="loc-header"><span id="locStatus">Detecting your locationâ€¦</span></div>
                    <div class="loc-details" id="locDetails">Allow location access when prompted</div>
                </div>
                <button id="retryLocBtn" type="button" title="Retry">â†º</button>
            </div>
            <div id="manualLocWrap" class="hidden">
                <div class="manual-label">ğŸ“Œ Or enter coordinates manually</div>
                <div class="manual-row">
                    <input type="number" id="manualLat" placeholder="Latitude  e.g. 29.9457" step="any">
                    <input type="number" id="manualLng" placeholder="Longitude e.g. 77.9801" step="any">
                    <button id="manualLocBtn" type="button">Use</button>
                </div>
            </div>
        </div>

        <button id="submitBtn" onclick="sendEmergency()">
            Send Emergency Alert â†’
        </button>
    </div>

    <!-- Loader -->
    <div id="loader" class="hidden">
        <div class="loader-inner">
            <div class="pulse-ring-wrap">
                <div class="pulse-ring"></div>
                <div class="pulse-ring-inner"></div>
            </div>
            <span class="loader-text">Processing Emergency Alert</span>
            <span class="loader-subtext">Analyzing Â· Routing Â· Connectingâ€¦</span>
        </div>
    </div>

    <!-- STEP 2: Triage -->
    <div class="card hidden" id="triageSection">
        <div class="card-title">
            <div class="icon">ğŸ©º</div>
            Triage Assessment
        </div>
        <div id="triageBox"></div>
    </div>

    <!-- STEP 2b: Hospitals -->
    <div class="card hidden" id="hospitalSection">
        <div class="card-title">
            <div class="icon">ğŸ¥</div>
            Nearby Hospitals
        </div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600;">Select a hospital to reserve a bed</p>
        <div id="hospitalList"></div>
    </div>

    <!-- STEP 3: Confirmation -->
    <div class="card hidden" id="confirmSection">
        <div id="confirmMsg"></div>
        <div class="confirm-links">
            <a href="/doctor-dashboard" class="link-dash">View Doctor Dashboard â†’</a>
            <a href="/result" class="link-result">View Full Summary</a>
        </div>
    </div>

</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Scripts (same logic, wired to new DOM) -->
<script>
/* â”€â”€ State â”€â”€ */
let state = {
  lat: null, lng: null, locReady: false,
  triageData: null, locationData: null,
  ambulance: null, doctorStatus: null, expectedBill: null
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEOLOCATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getLocation() {
  const locBox  = document.getElementById('locBox');
  const locIcon = document.getElementById('locIcon');
  const locStat = document.getElementById('locStatus');
  const locDet  = document.getElementById('locDetails');
  const manWrap = document.getElementById('manualLocWrap');

  locBox.className = '';
  locIcon.textContent = 'â³';
  locStat.textContent = 'Detecting your locationâ€¦';
  locDet.textContent  = 'Allow location access when prompted';

  if (!navigator.geolocation) {
    locIcon.textContent = 'âš ï¸';
    locStat.textContent = 'Geolocation not supported';
    locDet.textContent  = 'Enter coordinates manually below';
    locBox.className = 'loc-error';
    manWrap.classList.remove('hidden');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      state.lat = pos.coords.latitude;
      state.lng = pos.coords.longitude;
      state.locReady = true;
      locBox.className = 'loc-ready';
      locIcon.textContent = 'ğŸ“';
      locStat.textContent = 'Location acquired';
      locDet.textContent  = `${state.lat.toFixed(5)}, ${state.lng.toFixed(5)}`;
      checkReady();
    },
    () => {
      locBox.className = 'loc-error';
      locIcon.textContent = 'âš ï¸';
      locStat.textContent = 'Location access denied';
      locDet.textContent  = 'Enter coordinates manually below';
      manWrap.classList.remove('hidden');
    },
    { timeout: 8000, maximumAge: 60000 }
  );
}

document.getElementById('retryLocBtn').onclick = getLocation;

document.getElementById('manualLocBtn').onclick = function () {
  const lat = parseFloat(document.getElementById('manualLat').value);
  const lng = parseFloat(document.getElementById('manualLng').value);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
    showToast('âš ï¸ Enter valid lat/lng coordinates', 'warn'); return;
  }
  state.lat = lat; state.lng = lng; state.locReady = true;
  const locBox = document.getElementById('locBox');
  locBox.className = 'loc-ready';
  document.getElementById('locIcon').textContent   = 'ğŸ“Œ';
  document.getElementById('locStatus').textContent = 'Manual coordinates set';
  document.getElementById('locDetails').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  document.getElementById('manualLocWrap').classList.add('hidden');
  checkReady();
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM READINESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('message').addEventListener('input', checkReady);

function checkReady() {
  const msg = document.getElementById('message').value.trim();
  const btn = document.getElementById('submitBtn');
  if (msg.length >= 10 && state.locReady) {
    btn.classList.add('btn-ready');
    btn.disabled = false;
  } else {
    btn.classList.remove('btn-ready');
    btn.disabled = true;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 1 â€” POST /emergency
   app.py expects: { message, lat, lng }
   returns: { triage, location, hospitals, ambulance_status, doctor_status, expected_bill }
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sendEmergency() {
  const msg = document.getElementById('message').value.trim();
  if (!msg || !state.locReady) return;

  document.getElementById('formSection').classList.add('hidden');
  const loader = document.getElementById('loader');
  loader.classList.remove('hidden');
  loader.style.animation = 'fadeUp 0.4s ease forwards';

  fetch('/emergency', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: msg, lat: state.lat, lng: state.lng })
  })
  .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
  .then(data => {
    if (data.error) throw new Error(data.error);
    loader.classList.add('hidden');

    // Store all response data in state for later use
    state.triageData   = data.triage;
    state.locationData = data.location;
    state.ambulance    = data.ambulance_status;
    state.doctorStatus = data.doctor_status;
    state.expectedBill = data.expected_bill;

    showTriage(data.triage);
    showHospitals(data.hospitals || []);
    setPill(2);

    // Persist to sessionStorage so page refresh can restore state
    sessionStorage.setItem('emergencySession', JSON.stringify({
      msg,
      lat: state.lat, lng: state.lng,
      triage:           data.triage,
      location:         data.location,
      hospitals:        data.hospitals,
      ambulance_status: data.ambulance_status,
      doctor_status:    data.doctor_status,
      expected_bill:    data.expected_bill
    }));
  })
  .catch(err => {
    loader.classList.add('hidden');
    document.getElementById('formSection').classList.remove('hidden');
    showToast('âŒ ' + (err.message || 'Server error'), 'error');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP PILLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setPill(step) {
  for (let i = 1; i <= 3; i++) {
    const p = document.getElementById('pill' + i);
    p.className = 'step-pill' + (i < step ? ' done' : i === step ? ' active' : '');
    if (i < step && i <= 2) {
      document.getElementById('conn' + i).classList.add('connector-done');
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRIAGE DISPLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTriage(t) {
  const sec = document.getElementById('triageSection');
  sec.classList.remove('hidden');
  sec.style.animation = 'fadeUp 0.5s ease forwards';

  const score    = t.severity_score ?? 0;
  const level    = (t.severity_level ?? 'unknown').toLowerCase();
  const badgeCls = level.includes('critical') ? 'badge-critical'
                 : level.includes('moderate') ? 'badge-moderate' : 'badge-low';
  const color    = level.includes('critical') ? 'var(--red)'
                 : level.includes('moderate') ? 'var(--amber)' : 'var(--green)';

  const items = [
    { label: 'Severity Level',  value: `<span class="badge ${badgeCls}">${(t.severity_level||'').toUpperCase()}</span>` },
    { label: 'Severity Score',  value: `<div class="severity-row"><span class="score-num" style="color:${color}">${score}/10</span></div><div class="severity-bar-wrap"><div class="severity-bar" id="sevBar" style="width:0%"></div></div>` },
    { label: 'Emergency Type',  value: t.emergency_type      ?? t.condition ?? 'â€”' },
    { label: 'Priority',        value: t.priority            ?? 'â€”' },
  ];
  if (t.required_specialist)      items.push({ label: 'Specialist',  value: t.required_specialist });
  if (t.recommended_department)   items.push({ label: 'Department',  value: t.recommended_department });
  if (t.estimated_arrival)        items.push({ label: 'Est. ETA',    value: t.estimated_arrival + ' min' });

  document.getElementById('triageBox').innerHTML = `
    <div class="triage-grid">
      ${items.map(i => `<div class="triage-item"><span class="triage-label">${i.label}</span><div class="triage-value">${i.value}</div></div>`).join('')}
    </div>
    ${t.notes ? `<div class="section-divider"></div><p style="font-size:13px;color:var(--muted);line-height:1.7">${t.notes}</p>` : ''}
  `;
  setTimeout(() => {
    const bar = document.getElementById('sevBar');
    if (bar) bar.style.width = (score * 10) + '%';
  }, 300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOSPITAL DISPLAY
   app.py hospital objects have: name, distance_km or distance_meters, beds_available
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showHospitals(list) {
  const sec = document.getElementById('hospitalSection');
  sec.classList.remove('hidden');
  sec.style.animation = 'fadeUp 0.5s ease 0.1s forwards';

  const container = document.getElementById('hospitalList');
  if (!list || !list.length) {
    container.innerHTML = '<div class="no-data">No hospitals found nearby.</div>';
    return;
  }
  container.innerHTML = list.map((h, i) => {
    const safeName = (h.name || '').replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const distKm   = h.distance_km       ? Number(h.distance_km).toFixed(1)
                   : h.distance_meters   ? (h.distance_meters / 1000).toFixed(1) : null;
    const distTxt  = distKm ? distKm + ' km away' : 'Distance unavailable';
    const beds     = h.beds_available ?? h.available_beds ?? '?';
    return `
    <div class="hospital-card" style="animation-delay:${i * 0.08}s" id="hosp${i}">
      <div class="hosp-info">
        <div class="hosp-name">${h.name}</div>
        <div class="hosp-dist">ğŸ“ ${distTxt} Â· ${beds} beds available</div>
      </div>
      <button class="btn-select" id="hospBtn${i}" onclick="selectHospital(${i}, '${safeName}')">Reserve</button>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 2 â€” POST /select-hospital
   app.py expects: { hospital_name, triage, location }
   returns: { message, case_id, hospital, available_beds }
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectHospital(idx, name) {
  // Disable all cards/buttons while processing
  document.querySelectorAll('.hospital-card').forEach((c, i) => {
    c.className = 'hospital-card' + (i === idx ? ' selected' : ' dimmed');
  });
  document.querySelectorAll('.btn-select').forEach((b, i) => {
    b.textContent = i === idx ? 'Reservingâ€¦' : 'Reserve';
    b.disabled = true;
  });

  fetch('/select-hospital', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      hospital_name: name,
      triage:        state.triageData,
      location:      state.locationData
    })
  })
  .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
  .then(data => {
    if (data.error) throw new Error(data.error);

    // Mark as confirmed in button
    document.querySelector(`#hospBtn${idx}`).textContent = 'âœ“ Reserved';

    showConfirmation(data, name);
    setPill(3);
    launchConfetti();

    // Save full result to sessionStorage for emergency_result.html
    sessionStorage.setItem('emergencyResult', JSON.stringify({
      reference_number: `EMG-${data.case_id}`,
      triage:           state.triageData,
      location:         state.locationData,
      location_coords:  state.lat && state.lng ? `${state.lat.toFixed(5)}, ${state.lng.toFixed(5)}` : '',
      ambulance_status: state.ambulance,
      doctor_status:    state.doctorStatus,
      expected_bill:    state.expectedBill,
      hospitals:        JSON.parse(sessionStorage.getItem('emergencySession') || '{}').hospitals || []
    }));
    sessionStorage.removeItem('emergencySession');
  })
  .catch(err => {
    showToast('âŒ Reservation failed: ' + err.message, 'error');
    document.querySelectorAll('.hospital-card').forEach(c => { c.className = 'hospital-card'; });
    document.querySelectorAll('.btn-select').forEach(b => { b.textContent = 'Reserve'; b.disabled = false; });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRMATION PANEL
   data from /select-hospital: { case_id, hospital, available_beds }
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showConfirmation(data, hospName) {
  const sec = document.getElementById('confirmSection');
  sec.classList.remove('hidden');
  sec.style.animation = 'fadeUp 0.5s ease forwards';
  document.getElementById('triageSection').classList.add('hidden');
  document.getElementById('hospitalSection').classList.add('hidden');

  const eta  = state.triageData?.estimated_arrival
                 ? state.triageData.estimated_arrival + ' min' : 'N/A';
  const ref  = data.case_id ? `EMG-${data.case_id}` : 'â€”';
  const dept = state.triageData?.recommended_department ?? 'ER';

  document.getElementById('confirmMsg').innerHTML = `
    <div class="confirm-icon">âœ…</div>
    <div class="confirm-title">Bed Reserved Successfully</div>
    <div class="confirm-grid">
      <div class="confirm-item">
        <span class="confirm-label">Hospital</span>
        <div class="confirm-val" style="font-size:14px;font-family:'Space Grotesk',sans-serif;font-weight:700">${hospName}</div>
      </div>
      <div class="confirm-item">
        <span class="confirm-label">ETA</span>
        <div class="confirm-val" style="color:var(--green)">${eta}</div>
      </div>
      <div class="confirm-item">
        <span class="confirm-label">Ref #</span>
        <div class="confirm-val" style="font-size:13px;font-family:'JetBrains Mono',monospace">${ref}</div>
      </div>
    </div>
    <p class="confirm-note">Your emergency has been logged and a bed is reserved in the
      <strong style="color:var(--text)">${dept}</strong> department.
      Medical staff have been notified and are preparing for your arrival.</p>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  clearTimeout(toastTimer);
  t.textContent = msg;
  t.className   = 'toast' + (type ? ' toast-' + type : '');
  void t.offsetWidth;
  t.classList.add('toast-show');
  toastTimer = setTimeout(() => t.classList.remove('toast-show'), 3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function launchConfetti() {
  const colors = ['#ff2d3b','#00e676','#3b82f6','#f59e0b','#fff'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = Math.random() * 8 + 5;
    el.style.cssText = `left:${Math.random()*100}vw;width:${size}px;height:${size}px;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      border-radius:${Math.random()>0.5?'50%':'2px'};
      opacity:${Math.random()*0.7+0.3};
      animation-duration:${Math.random()*2+2}s;
      animation-delay:${Math.random()*0.8}s;`;
    document.body.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION RESTORE
   1. Check server session via GET /session-state (survives hard refresh)
   2. Fall back to sessionStorage (survives tab navigation)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function restoreFromData(s) {
  if (!s || !s.triage || !s.hospitals) return false;
  document.getElementById('message').value = s.msg || '';
  state.lat          = s.lat;
  state.lng          = s.lng;
  state.locReady     = true;
  state.triageData   = s.triage;
  state.locationData = s.location;
  state.ambulance    = s.ambulance_status;
  state.doctorStatus = s.doctor_status;
  state.expectedBill = s.expected_bill;

  if (s.lat && s.lng) {
    const lb = document.getElementById('locBox');
    lb.className = 'loc-ready';
    document.getElementById('locIcon').textContent    = 'ğŸ“';
    document.getElementById('locStatus').textContent  = 'Location restored';
    document.getElementById('locDetails').textContent = `${Number(s.lat).toFixed(5)}, ${Number(s.lng).toFixed(5)}`;
  }
  showTriage(s.triage);
  showHospitals(s.hospitals);
  setPill(2);
  document.getElementById('formSection').classList.add('hidden');
  return true;
}

(async function initSession() {
  // 1. Try server-side session first
  try {
    const resp = await fetch('/session-state');
    if (resp.ok) {
      const srv = await resp.json();
      if (srv.emergency && srv.emergency.triage) {
        const em = srv.emergency;
        // If booking already exists, just show confirmation screen
        if (srv.booking) {
          state.triageData   = em.triage;
          state.locationData = em.location;
          state.ambulance    = em.ambulance_status;
          state.doctorStatus = em.doctor_status;
          state.expectedBill = em.expected_bill;
          document.getElementById('formSection').classList.add('hidden');
          showConfirmation({ case_id: srv.booking.case_id }, srv.booking.hospital_name);
          setPill(3);
          return;
        }
        // Triage done but no booking yet
        if (restoreFromData({ triage: em.triage, location: em.location, hospitals: em.hospitals,
          ambulance_status: em.ambulance_status, doctor_status: em.doctor_status,
          expected_bill: em.expected_bill, lat: null, lng: null })) return;
      }
    }
  } catch (_) {}

  // 2. Fall back to sessionStorage
  const saved = sessionStorage.getItem('emergencySession');
  if (!saved) return;
  try {
    const s = JSON.parse(saved);
    if (!s.triage || !s.hospitals) return;
    const banner = document.createElement('div');
    banner.className = 'restore-banner';
    banner.innerHTML = `
      <span>ğŸ“‚ You have an active emergency session</span>
      <div style="display:flex;gap:8px;flex-shrink:0">
        <button id="restoreYes">Restore</button>
        <button id="restoreNo" style="border-color:transparent;opacity:0.6">Dismiss</button>
      </div>`;
    document.querySelector('.container').prepend(banner);
    document.getElementById('restoreYes').onclick = () => { banner.remove(); restoreFromData(s); };
    document.getElementById('restoreNo').onclick  = () => { sessionStorage.removeItem('emergencySession'); banner.remove(); };
  } catch (_) { sessionStorage.removeItem('emergencySession'); }
})();

/* â”€â”€ Init â”€â”€ */
getLocation();
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EMERGENCYAI FLOATING CHATBOT  â€” predefined KB + Anthropic API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
/* â”€â”€â”€ FAB â”€â”€â”€ */
.chat-fab{position:fixed;bottom:28px;right:28px;width:58px;height:58px;border-radius:50%;background:var(--red,#ff2d3b);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 6px 28px rgba(255,45,59,.45);z-index:8900;transition:transform .3s cubic-bezier(.34,1.56,.64,1),box-shadow .3s;animation:fabPulse 2.6s ease-in-out infinite;}
.chat-fab:hover{transform:scale(1.1);}
.chat-fab.open{animation:none;transform:scale(.92);}
@keyframes fabPulse{0%,100%{box-shadow:0 6px 28px rgba(255,45,59,.4);}50%{box-shadow:0 8px 44px rgba(255,45,59,.65),0 0 70px rgba(255,45,59,.15);}}
.fab-dot{position:absolute;top:4px;right:4px;width:11px;height:11px;border-radius:50%;background:#00e676;border:2px solid var(--bg,#0a0b0d);animation:blinkDot 1.8s ease-in-out infinite;}
@keyframes blinkDot{0%,100%{opacity:1;}50%{opacity:.25;}}
.fab-ico-chat{display:block}.fab-ico-x{display:none}
.chat-fab.open .fab-ico-chat{display:none}.chat-fab.open .fab-ico-x{display:block}

/* â”€â”€â”€ WINDOW â”€â”€â”€ */
.chat-win{position:fixed;bottom:100px;right:28px;width:370px;max-height:590px;background:var(--surface,#111318);border:1px solid rgba(255,255,255,.08);border-radius:22px;box-shadow:0 28px 90px rgba(0,0,0,.75),0 0 0 1px rgba(255,45,59,.05);display:flex;flex-direction:column;overflow:hidden;z-index:8899;transform-origin:bottom right;transform:scale(.85) translateY(20px);opacity:0;pointer-events:none;transition:transform .35s cubic-bezier(.34,1.56,.64,1),opacity .28s ease;}
.chat-win.show{transform:scale(1) translateY(0);opacity:1;pointer-events:all;}
.chat-win::before{content:'';display:block;height:2px;background:linear-gradient(90deg,var(--red,#ff2d3b),rgba(255,45,59,.25),transparent);flex-shrink:0;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.cw-head{display:flex;align-items:center;gap:10px;padding:14px 16px 12px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.cw-ava{width:38px;height:38px;border-radius:11px;background:var(--red,#ff2d3b);display:flex;align-items:center;justify-content:center;font-size:19px;position:relative;flex-shrink:0;}
.cw-ava::after{content:'';position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;border-radius:50%;background:#00e676;border:2px solid var(--surface,#111318);animation:blinkDot 2s ease-in-out infinite;}
.cw-info{flex:1}
.cw-name{font-family:'Bebas Neue','Space Grotesk',sans-serif;font-size:15px;letter-spacing:.08em;color:var(--text,#f0f2f5);line-height:1;}
.cw-status{font-size:10px;font-weight:700;color:#00e676;letter-spacing:.08em;text-transform:uppercase;margin-top:2px;}
.cw-hbtn{width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);color:var(--muted,#6b7280);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;}
.cw-hbtn:hover{border-color:rgba(255,255,255,.15);color:var(--text,#f0f2f5);}

/* â”€â”€â”€ QUICK CHIPS â”€â”€â”€ */
.cw-chips{display:flex;gap:5px;flex-wrap:wrap;padding:9px 12px 7px;border-bottom:1px solid rgba(255,255,255,.04);flex-shrink:0;}
.cw-chip{padding:4px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--muted,#6b7280);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;font-family:'Space Grotesk',sans-serif;}
.cw-chip:hover{border-color:rgba(255,45,59,.45);color:var(--red,#ff2d3b);background:rgba(255,45,59,.06);}

/* â”€â”€â”€ MESSAGES â”€â”€â”€ */
.cw-msgs{flex:1;overflow-y:auto;padding:12px 12px 4px;display:flex;flex-direction:column;gap:9px;scroll-behavior:smooth;}
.cw-msgs::-webkit-scrollbar{width:3px;}
.cw-msgs::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px;}
.cw-msg{display:flex;gap:7px;align-items:flex-end;animation:msgIn .28s ease forwards;opacity:0;}
.cw-msg.u{flex-direction:row-reverse;}
@keyframes msgIn{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.cw-mava{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.cw-mava.b{background:rgba(255,45,59,.1);border:1px solid rgba(255,45,59,.2);}
.cw-mava.u{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);}
.cw-bbl{max-width:80%;padding:9px 13px;border-radius:13px;font-size:13px;line-height:1.6;position:relative;}
.cw-bbl.b{background:var(--surface-2,#181c24);border:1px solid rgba(255,255,255,.07);color:var(--text,#f0f2f5);border-bottom-left-radius:3px;}
.cw-bbl.u{background:var(--red,#ff2d3b);color:#fff;border-bottom-right-radius:3px;box-shadow:0 4px 14px rgba(255,45,59,.3);}
.cw-bbl strong{color:var(--green,#00e676);}
.cw-bbl em{color:var(--amber,#f59e0b);font-style:normal;font-weight:600;}
.cw-time{font-size:9px;color:var(--muted-2,#4b5563);margin-top:3px;display:block;font-family:'JetBrains Mono',monospace;}

/* typing dots */
.cw-typing{display:flex;gap:4px;align-items:center;padding:4px 2px;}
.cw-typing span{width:6px;height:6px;border-radius:50%;background:var(--muted,#6b7280);animation:typeDot .9s ease-in-out infinite;}
.cw-typing span:nth-child(2){animation-delay:.15s;}
.cw-typing span:nth-child(3){animation-delay:.3s;}
@keyframes typeDot{0%,80%,100%{transform:scale(.8);opacity:.4;}40%{transform:scale(1.1);opacity:1;}}

/* â”€â”€â”€ INPUT â”€â”€â”€ */
.cw-foot{display:flex;gap:8px;padding:10px 12px 14px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.cw-inp{flex:1;background:var(--surface-2,#181c24);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:9px 13px;font-size:13px;color:var(--text,#f0f2f5);font-family:'Space Grotesk',sans-serif;outline:none;transition:border-color .2s,box-shadow .2s;resize:none;max-height:80px;line-height:1.5;}
.cw-inp:focus{border-color:rgba(255,45,59,.45);box-shadow:0 0 0 3px rgba(255,45,59,.07);}
.cw-inp::placeholder{color:var(--muted-2,#4b5563);}
.cw-send{width:38px;height:38px;border-radius:10px;border:none;background:var(--red,#ff2d3b);color:#fff;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;align-self:flex-end;}
.cw-send:hover{background:#e8001a;transform:translateY(-1px);box-shadow:0 4px 14px rgba(255,45,59,.4);}
.cw-send:disabled{opacity:.4;cursor:not-allowed;transform:none;}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:480px){
  .chat-win{width:calc(100vw - 24px);right:12px;bottom:88px;}
  .chat-fab{bottom:20px;right:16px;}
}
</style>

<!-- FAB Button -->
<button class="chat-fab" id="chatFab" aria-label="Open AI Assistant">
  <span class="fab-ico-chat">ğŸ¤–</span>
  <span class="fab-ico-x">âœ•</span>
  <span class="fab-dot"></span>
</button>

<!-- Chat Window -->
<div class="chat-win" id="chatWin">
  <div class="cw-head">
    <div class="cw-ava">ğŸš¨</div>
    <div class="cw-info">
      <div class="cw-name">EmergencyAI Assistant</div>
      <div class="cw-status">â— Online â€” Always here</div>
    </div>
    <button class="cw-hbtn" id="chatClearBtn" title="Clear chat">ğŸ—‘</button>
    <button class="cw-hbtn" id="chatCloseBtn" title="Close">âœ•</button>
  </div>

  <div class="cw-chips" id="chatChips"></div>
  <div class="cw-msgs"  id="chatMsgs"></div>

  <div class="cw-foot">
    <textarea class="cw-inp" id="chatInp" rows="1"
      placeholder="Ask anything about your emergencyâ€¦"></textarea>
    <button class="cw-send" id="chatSend">â¤</button>
  </div>
</div>

<script>
(function(){
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE DETECTION â€” determines which KB + chips to load
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGE = (function(){
  const p = window.location.pathname;
  if(p.includes('result'))    return 'result';
  if(p.includes('dashboard')) return 'dashboard';
  return 'form';
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREDEFINED KNOWLEDGE BASE (no API needed for common Qs)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const KB = {
  form: [
    { q:['how does this work','what is this','explain'], a:`<strong>EmergencyAI</strong> is a rapid-response system.\n\n<em>Step 1</em> â€” Describe your emergency & allow location access.\n<em>Step 2</em> â€” Our AI triages your case and finds nearby hospitals.\n<em>Step 3</em> â€” Select a hospital to instantly reserve a bed.\n\nAmbulance dispatch and doctor assignment happen automatically.` },
    { q:['location','gps','coordinates','allow location'], a:`Your location is detected via browser GPS for maximum accuracy. If blocked:\n\nâ€¢ Click <em>â†º retry</em> after allowing access in your browser\nâ€¢ Or enter <em>Latitude / Longitude</em> manually in the fields below the location box\n\nYour coordinates are only used to find nearby hospitals â€” never stored.` },
    { q:['triage','severity','score','assessed'], a:`Our AI triage engine analyzes your description and assigns:\n\n<strong>Severity Score</strong> â€” 1 (mild) to 10 (life-threatening)\n<strong>Severity Level</strong> â€” Low / Moderate / Critical\n<strong>Specialist</strong> â€” Which doctor you need\n<strong>Department</strong> â€” Which hospital wing to prepare\n\nHigher scores get faster response and priority routing.` },
    { q:['hospital','bed','reserve','select'], a:`We show the <strong>nearest hospitals</strong> with available beds, sorted by distance.\n\nClick <em>Reserve</em> on any hospital to instantly book a bed. The hospital is notified immediately and medical staff begin preparing for your arrival.` },
    { q:['ambulance','dispatch','transport'], a:`Once you reserve a bed, an ambulance is automatically dispatched to your GPS location.\n\nYou can track status on the <strong>Emergency Summary</strong> page:\n<em>Received â†’ Dispatched â†’ En Route â†’ Arrived</em>` },
    { q:['cost','bill','charge','price','fee'], a:`An <em>estimated bill</em> is shown after triage â€” it's a rough range based on emergency type and hospital rates. Final billing happens at the hospital after treatment.\n\nAll costs shown are estimates only.` },
    { q:['emergency','help','urgent','call','911'], a:`âš ï¸ If this is a <strong>life-threatening emergency</strong>, call <em>112</em> (India) immediately alongside using this form.\n\nThis system is designed to <strong>speed up hospital arrival</strong> by pre-reserving a bed and dispatching an ambulance â€” but for cardiac arrest or major trauma, also call emergency services.` },
    { q:['what to type','describe','message','explain emergency'], a:`Be as specific as possible. Include:\n\nâ€¢ <em>What happened</em> (e.g. "chest pain", "road accident")\nâ€¢ <em>Patient age</em> and gender if possible\nâ€¢ <em>Duration</em> of symptoms\nâ€¢ <em>Any known conditions</em> (diabetes, heart diseaseâ€¦)\n\nExample: <strong>"55-year-old male, severe chest pain radiating to left arm, started 20 mins ago, history of hypertension"</strong>` },
  ],

  result: [
    { q:['reference','ref','id','case number'], a:`Your <strong>Reference Number</strong> (e.g. EMG-8847) is shown at the top of this page. Share it with hospital staff on arrival â€” they use it to pull up your pre-registered case instantly.` },
    { q:['severity','score','critical','moderate','low'], a:`Severity levels explained:\n\n<strong>Critical (7â€“10)</strong> â€” Life-threatening. Immediate intervention required. ICU/resus team alerted.\n<strong>Moderate (4â€“6)</strong> â€” Urgent but stable. Priority queue at ER.\n<em>Low (1â€“3)</em> â€” Non-emergency. Standard ER queue.` },
    { q:['ambulance','status','en route','dispatched','eta'], a:`The ambulance dispatch panel shows real-time status:\n\n<em>Received</em> â†’ Alert logged in dispatch system\n<em>Dispatched</em> â†’ Ambulance assigned & departing\n<em>En Route</em> â†’ Ambulance heading to your location\n<em>Arrived</em> â†’ Team on scene\n\nETA is estimated based on distance and traffic.` },
    { q:['doctor','physician','specialist','assigned'], a:`The <strong>Assigned Medical Team</strong> section shows doctors preparing for your arrival.\n\nStatus badges mean:\n<em>Preparing</em> â€” In hospital, reading your case\n<em>En Route</em> â€” Traveling to the hospital\n<em>Available</em> â€” Ready and waiting for you` },
    { q:['hospital','bed','reserved','which hospital'], a:`Your chosen hospital is marked with âœ“ in the hospitals section. The bed is <strong>reserved and held</strong> for you â€” staff have been notified and the department is preparing.\n\nBring your Reference Number on arrival.` },
    { q:['bill','cost','estimate','payment'], a:`The estimated bill is a <em>pre-arrival estimate</em> based on your emergency type and typical hospital rates. Final charges depend on:\n\nâ€¢ Actual treatment required\nâ€¢ Medications and procedures\nâ€¢ Duration of stay\n\nArrange payment/insurance at the hospital's billing counter.` },
    { q:['new emergency','start over','another'], a:`To submit a new emergency, click <strong>"Submit New Emergency â†’"</strong> at the bottom of this page, or go back to the home page. Your current case will remain in the system for doctors to manage.` },
    { q:['dashboard','doctor','view'], a:`The <strong>Doctor Dashboard</strong> shows all active cases in real time. Doctors use it to accept cases, track ambulance status, and mark cases complete.\n\nClick "View Doctor Dashboard â†’" to see your case from the medical team's perspective.` },
  ],

  dashboard: [
    { q:['accept','how to accept','take case'], a:`To accept a case, click the <strong>ğŸš‘ Accept</strong> button on any card with <em>Bed Reserved</em> status.\n\nThis:\nâ€¢ Triggers ambulance dispatch via the dispatch agent\nâ€¢ Changes status to <em>En Route</em>\nâ€¢ Notifies the patient's result page in real time` },
    { q:['complete','finish','close case'], a:`Click <strong>âœ“ Complete</strong> on any <em>En Route</em> case when the patient has arrived and been admitted.\n\nThis:\nâ€¢ Frees the reserved bed (bed counter decrements)\nâ€¢ Changes status to <em>Completed</em>\nâ€¢ Removes the case from active queue` },
    { q:['filter','search','find case'], a:`Use the filter buttons to narrow cases:\n<em>All</em> â€” every active case\n<em>Reserved</em> â€” awaiting acceptance\n<em>En Route</em> â€” ambulance dispatched\n<em>Completed</em> â€” resolved cases\n<em>âš¡ Critical</em> â€” severity 7â€“10 only\n\nOr use the <strong>search box</strong> to find by patient name, case ID, or location.` },
    { q:['stats','numbers','count','total'], a:`The four stat cards at the top update live:\n\n<strong>Total Cases</strong> â€” all submissions today\n<strong>Bed Reserved</strong> â€” awaiting doctor acceptance\n<strong>En Route</strong> â€” ambulance dispatched, patient incoming\n<strong>Completed</strong> â€” resolved today` },
    { q:['ambulance','dispatch','driver'], a:`Each case card shows the <strong>assigned ambulance</strong> (ID + driver name + plate number) and its current status.\n\nStatuses: <em>Dispatched â†’ En Route â†’ Arrived</em>\n\nThe ETA pill blinks red when under 10 minutes away.` },
    { q:['severity','critical','urgent','priority'], a:`Cases are color-coded by severity:\n\nğŸ”´ <strong>Critical</strong> â€” Red accent bar, card pulses. Accept immediately.\nğŸŸ¡ <strong>Moderate</strong> â€” Amber accent bar. Urgent but stable.\nğŸŸ¢ <em>Low</em> â€” Green accent bar. Non-critical.\n\nCritical cards animate continuously as a visual alert.` },
    { q:['refresh','update','live','real time'], a:`The dashboard <strong>auto-refreshes every 30 seconds</strong>. New cases pop in with a cyan flash animation.\n\nClick the <em>â†» refresh button</em> in the top bar to force an immediate update. The timestamp shows last sync time.` },
    { q:['specialist','department','doctor'], a:`Each case card shows the:\nâ€¢ <em>Required Specialist</em> â€” e.g. Cardiologist, Trauma Surgeon\nâ€¢ <em>Department</em> â€” e.g. ICU, ER, Neurology\nâ€¢ <em>Assigned Doctor</em> â€” name, specialty, and preparation status\n\nThis helps the correct team prepare before the patient arrives.` },
  ]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUICK CHIPS PER PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CHIPS = {
  form:      ['How does this work?', 'What to type?', 'Location issues', 'Ambulance info', 'Cost estimate'],
  result:    ['What\'s my ref #?', 'Ambulance status', 'Doctor assigned?', 'Which hospital?', 'Cost estimate'],
  dashboard: ['How to accept?', 'Filter cases', 'Stats explained', 'Severity levels', 'Auto-refresh'],
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WELCOME MESSAGE PER PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WELCOME = {
  form:      `ğŸ‘‹ Hi! I'm your <strong>EmergencyAI Assistant</strong>.\n\nI can help you with:\nâ€¢ Filling in the emergency form\nâ€¢ Understanding triage & severity\nâ€¢ Location & hospital questions\nâ€¢ Ambulance & cost info\n\nWhat do you need help with?`,
  result:    `ğŸ‘‹ Hello! I'm here to help you understand your <strong>Emergency Summary</strong>.\n\nAsk me about your:\nâ€¢ Reference number & case status\nâ€¢ Ambulance dispatch & ETA\nâ€¢ Assigned doctors & hospital\nâ€¢ Estimated bill\n\nHow can I assist?`,
  dashboard: `ğŸ‘‹ Welcome, Doctor! I'm your <strong>Dashboard Assistant</strong>.\n\nI can help with:\nâ€¢ Accepting & completing cases\nâ€¢ Understanding severity levels\nâ€¢ Filtering & searching cases\nâ€¢ Dispatch & ambulance info\n\nWhat do you need?`,
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FALLBACK ANSWERS for unmatched questions
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FALLBACK = [
  `I don't have a specific answer for that, but I'm trained on all EmergencyAI features.\n\nTry asking about:\nâ€¢ <em>Triage & severity scores</em>\nâ€¢ <em>Hospital bed reservation</em>\nâ€¢ <em>Ambulance dispatch</em>\nâ€¢ <em>Cost estimates</em>\n\nOr rephrase your question!`,
  `That's outside my knowledge base for this page. Try one of the quick-action chips above for common questions, or ask about ambulances, hospitals, doctors, or costs.`,
  `I'm specialized in EmergencyAI workflows. For that specific query, please contact hospital support directly.\n\nI <em>can</em> help with anything on this page â€” triage, dispatch, bed reservations, or doctor assignments.`,
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let chatHistory = [];
let isTyping    = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM REFS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fab      = document.getElementById('chatFab');
const win      = document.getElementById('chatWin');
const msgsEl   = document.getElementById('chatMsgs');
const inpEl    = document.getElementById('chatInp');
const sendBtn  = document.getElementById('chatSend');
const chipsEl  = document.getElementById('chatChips');
const clearBtn = document.getElementById('chatClearBtn');
const closeBtn = document.getElementById('chatCloseBtn');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(CHIPS[PAGE] || CHIPS.form).forEach(txt => {
  const c = document.createElement('button');
  c.className   = 'cw-chip';
  c.textContent = txt;
  c.onclick     = () => sendMessage(txt);
  chipsEl.appendChild(c);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
fab.onclick = () => {
  const opening = !win.classList.contains('show');
  fab.classList.toggle('open', opening);
  win.classList.toggle('show', opening);
  if (opening && msgsEl.children.length === 0) {
    addBotMsg(WELCOME[PAGE] || WELCOME.form);
  }
  if (opening) setTimeout(() => inpEl.focus(), 350);
};
closeBtn.onclick = () => { fab.classList.remove('open'); win.classList.remove('show'); };
clearBtn.onclick = () => {
  chatHistory = [];
  msgsEl.innerHTML = '';
  addBotMsg(WELCOME[PAGE] || WELCOME.form);
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function nowTime(){
  return new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
}

function addBotMsg(html, skipHistory){
  const wrap = document.createElement('div');
  wrap.className = 'cw-msg';
  wrap.innerHTML = `
    <div class="cw-mava b">ğŸš¨</div>
    <div>
      <div class="cw-bbl b">${html.replace(/\n/g,'<br>')}</div>
      <span class="cw-time">${nowTime()}</span>
    </div>`;
  msgsEl.appendChild(wrap);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  if(!skipHistory) chatHistory.push({role:'assistant', content: html.replace(/<[^>]+>/g,'')});
}

function addUserMsg(text){
  const wrap = document.createElement('div');
  wrap.className = 'cw-msg u';
  wrap.innerHTML = `
    <div class="cw-mava u">ğŸ‘¤</div>
    <div>
      <div class="cw-bbl u">${escHtml(text)}</div>
      <span class="cw-time" style="text-align:right">${nowTime()}</span>
    </div>`;
  msgsEl.appendChild(wrap);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  chatHistory.push({role:'user', content: text});
}

function showTyping(){
  const el = document.createElement('div');
  el.className = 'cw-msg';
  el.id = 'chatTyping';
  el.innerHTML = `<div class="cw-mava b">ğŸš¨</div><div class="cw-bbl b"><div class="cw-typing"><span></span><span></span><span></span></div></div>`;
  msgsEl.appendChild(el);
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

function hideTyping(){
  const el = document.getElementById('chatTyping');
  if(el) el.remove();
}

function escHtml(t){
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KB MATCH â€” check predefined answers first
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function matchKB(text){
  const lower = text.toLowerCase();
  const kb     = KB[PAGE] || KB.form;
  for(const entry of kb){
    if(entry.q.some(kw => lower.includes(kw))) return entry.a;
  }
  // cross-page general matches
  for(const page of Object.values(KB)){
    for(const entry of page){
      if(entry.q.some(kw => lower.includes(kw))) return entry.a;
    }
  }
  return null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANTHROPIC API CALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callAnthropicAPI(userText){
  const pageCtx = {
    form:      'The user is on the Emergency Form page where they describe their emergency, get triaged, and select a hospital to reserve a bed.',
    result:    'The user is on the Emergency Summary/Result page showing triage data, ambulance dispatch status, assigned doctors, and nearby hospitals.',
    dashboard: 'The user is a doctor viewing the Doctor Dashboard which shows all active emergency cases with accept/complete actions.',
  }[PAGE];

  const systemPrompt = `You are EmergencyAI Assistant, an expert helper for the EmergencyAI rapid-response medical system built with Flask/Python backend.
${pageCtx}

Answer questions about: emergency forms, triage & severity scores, hospital bed reservation, ambulance dispatch, doctor assignment, cost estimates, and dashboard operations.
Keep responses concise (under 120 words), practical, and use simple formatting.
Never make up medical advice â€” stick to how the system works.
If asked something unrelated, redirect politely to EmergencyAI features.`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 300,
      system: systemPrompt,
      messages: [
        ...chatHistory.slice(-6).map(m => ({role: m.role, content: m.content})),
        {role: 'user', content: userText}
      ]
    })
  });

  if(!response.ok) throw new Error('API error');
  const data = await response.json();
  return data.content?.[0]?.text || 'Sorry, I could not generate a response.';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND MESSAGE â€” KB first, API fallback
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendMessage(text){
  text = text.trim();
  if(!text || isTyping) return;

  addUserMsg(text);
  inpEl.value = '';
  inpEl.style.height = '';
  isTyping = true;
  sendBtn.disabled = true;

  showTyping();

  // Small realistic delay
  await new Promise(r => setTimeout(r, 450 + Math.random()*400));

  // 1. Try KB match
  const kbAnswer = matchKB(text);
  if(kbAnswer){
    hideTyping();
    addBotMsg(kbAnswer);
    isTyping = false;
    sendBtn.disabled = false;
    return;
  }

  // 2. Try Anthropic API
  try {
    const apiAnswer = await callAnthropicAPI(text);
    hideTyping();
    addBotMsg(apiAnswer);
  } catch(_){
    // 3. Fallback
    hideTyping();
    const fb = FALLBACK[Math.floor(Math.random() * FALLBACK.length)];
    addBotMsg(fb);
  }

  isTyping = false;
  sendBtn.disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT HANDLERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
sendBtn.onclick = () => sendMessage(inpEl.value);

inpEl.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage(inpEl.value);
  }
});

// Auto-resize textarea
inpEl.addEventListener('input', () => {
  inpEl.style.height = '';
  inpEl.style.height = Math.min(inpEl.scrollHeight, 80) + 'px';
});

})();
</script>

</body>
</html>